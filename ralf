#!/bin/bash
# Ralph - Autonomous AI Coding Loop
# Based on the Ralph technique by Jeffrey Huntley

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BLACKBOX5_DIR="$SCRIPT_DIR"
ENGINE_DIR="$BLACKBOX5_DIR/2-engine/.autonomous"

# Project is the parent of blackbox5 (SISO-INTERNAL)
PROJECT_DIR="$(cd "$BLACKBOX5_DIR/.." && pwd)"
PROJECT_AUTONOMOUS="$PROJECT_DIR/.autonomous"

PROMPT_FILE="$ENGINE_DIR/prompts/ralf.md"

if [ ! -f "$PROMPT_FILE" ]; then
    echo "Error: Prompt file not found at $PROMPT_FILE"
    exit 1
fi

# Export environment variables for the prompt
echo "Starting Ralph loop..."
echo "RALF_PROJECT_DIR: $PROJECT_AUTONOMOUS"
echo "RALF_ENGINE_DIR: $ENGINE_DIR"
echo "Prompt: $PROMPT_FILE"
echo ""

# The classic Ralph loop from the video
while true; do
    echo "=== Ralph Loop Iteration ==="
    echo "Time: $(date)"
    echo ""

    # Export paths for the prompt to use
    export RALF_PROJECT_DIR="$PROJECT_AUTONOMOUS"
    export RALF_ENGINE_DIR="$ENGINE_DIR"
    export RALF_BLACKBOX5_DIR="$BLACKBOX5_DIR"

    # Cat prompt to Claude with permissions skip (as shown in video)
    if ! cat "$PROMPT_FILE" | claude --dangerously-skip-permissions; then
        echo "Claude exited with error, waiting 10 seconds before retry..."
        sleep 10
    fi

done
