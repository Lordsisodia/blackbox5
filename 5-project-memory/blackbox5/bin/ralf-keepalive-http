#!/bin/bash
#
# RALF Keep-Alive HTTP Server using Python
# Purpose: Simple HTTP server that responds to UptimeRobot pings
# This prevents GitHub Codespace from sleeping
#

set -euo pipefail

PORT="${RALF_KEEPALIVE_PORT:-8080}"
PROJECT_DIR="${RALF_PROJECT_DIR:-/opt/ralf/5-project-memory/blackbox5}"
LOG_FILE="$PROJECT_DIR/.autonomous/keepalive.log"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() { echo -e "${BLUE}[KEEPALIVE]${NC} $*" | tee -a "$LOG_FILE"; }
success() { echo -e "${GREEN}[OK]${NC} $*" | tee -a "$LOG_FILE"; }
error() { echo -e "${RED}[ERROR]${NC} $*" | tee -a "$LOG_FILE"; }

# Create a simple HTTP server using Python
create_server_script() {
    cat > /tmp/ralf_keepalive_server.py << 'PYTHON_EOF'
import http.server
import socketserver
import datetime
import sys

PORT = int(sys.argv[1]) if len(sys.argv) > 1 else 8080

class Handler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        response = f"RALF Keep-Alive OK - {datetime.datetime.utcnow().isoformat()}"
        self.wfile.write(response.encode())

    def log_message(self, format, *args):
        # Suppress logs
        pass

with socketserver.TCPServer(("", PORT), Handler) as httpd:
    print(f"Server running on port {PORT}", file=sys.stderr)
    httpd.serve_forever()
PYTHON_EOF
}

# Start the server
start_server() {
    log "Starting HTTP keep-alive server on port $PORT..."

    # Create log directory
    mkdir -p "$(dirname "$LOG_FILE")"

    # Check if already running
    if [[ -f /tmp/ralf_keepalive.pid ]]; then
        local old_pid=$(cat /tmp/ralf_keepalive.pid 2>/dev/null || echo "")
        if [[ -n "$old_pid" ]] && kill -0 "$old_pid" 2>/dev/null; then
            log "Server already running (PID: $old_pid)"
            return 0
        fi
    fi

    # Create server script
    create_server_script

    # Start Python server in background
    nohup python3 /tmp/ralf_keepalive_server.py "$PORT" >> "$LOG_FILE" 2>&1 &
    local pid=$!

    # Save PID
    echo $pid > /tmp/ralf_keepalive.pid

    # Wait and verify
    sleep 2

    if kill -0 $pid 2>/dev/null; then
        success "HTTP server running on port $PORT (PID: $pid)"

        # Test locally
        if curl -s http://localhost:$PORT > /dev/null 2>&1; then
            success "Local test passed"
        else
            error "Local test failed - server may not be responding"
        fi

        # Show codespace URL if available
        if [[ -n "${CODESPACE_NAME:-}" ]]; then
            log "Public URL: https://${CODESPACE_NAME}-${PORT}.app.github.dev"
            log "Add this to UptimeRobot"
        fi

        return 0
    else
        error "Failed to start server"
        return 1
    fi
}

# Stop the server
stop_server() {
    if [[ -f /tmp/ralf_keepalive.pid ]]; then
        local pid=$(cat /tmp/ralf_keepalive.pid)
        if kill -0 $pid 2>/dev/null; then
            kill $pid 2>/dev/null || true
            log "Server stopped (PID: $pid)"
        fi
        rm -f /tmp/ralf_keepalive.pid
    else
        log "No server running"
    fi
}

# Check status
status() {
    if [[ -f /tmp/ralf_keepalive.pid ]]; then
        local pid=$(cat /tmp/ralf_keepalive.pid)
        if kill -0 $pid 2>/dev/null; then
            success "Server is RUNNING (PID: $pid, Port: $PORT)"
            # Test it
            if curl -s http://localhost:$PORT > /dev/null 2>&1; then
                success "Responding to requests"
            else
                error "Not responding to requests"
            fi
        else
            error "Server is STOPPED (stale PID file)"
        fi
    else
        error "Server is STOPPED"
    fi
}

# Main command handler
case "${1:-start}" in
    start)
        start_server
        ;;
    stop)
        stop_server
        ;;
    restart)
        stop_server
        sleep 1
        start_server
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: ralf-keepalive-http [start|stop|restart|status]"
        exit 1
        ;;
esac
