#!/bin/bash
# RALF Weekly Report Generator
# Usage: ralf-report [--weekly|--daily|--since DATE]

set -e

BLACKBOX5_DIR="/Users/shaansisodia/.blackbox5"
LOG_INGESTOR="$BLACKBOX5_DIR/2-engine/.autonomous/lib/log_ingestor.py"
REPORTS_DIR="$BLACKBOX5_DIR/5-project-memory/blackbox5/knowledge/ralf-patterns/reports"

mkdir -p "$REPORTS_DIR"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

generate_report() {
    local period="${1:-weekly}"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local report_file="$REPORTS_DIR/${period}-${timestamp}.md"

    echo -e "${BLUE}Generating $period report...${NC}"

    # Get insights as JSON
    local insights
    insights=$(python3 "$LOG_INGESTOR" --limit 50 --json 2>/dev/null)

    local branch=$(echo "$insights" | python3 -c "import sys, json; print(json.load(sys.stdin).get('branch', 'unknown'))")
    local success_rate=$(echo "$insights" | python3 -c "import sys, json; print(json.load(sys.stdin).get('success_rate', 0))")
    local total=$(echo "$insights" | python3 -c "import sys, json; print(json.load(sys.stdin).get('total_loops_analyzed', 0))")

    cat > "$report_file" << EOF
# RALF $period Report

**Generated:** $(date -Iseconds)
**Branch:** $branch
**Period:** $period

## Summary

- **Total loops analyzed:** $total
- **Success rate:** ${success_rate}%
- **Status:** $(if [ "${success_rate%.*}" -ge 80 ]; then echo "âœ… Healthy"; elif [ "${success_rate%.*}" -ge 50 ]; then echo "âš ï¸  Degraded"; else echo "ðŸ”´ Critical"; fi)

## Status Distribution

\`\`\`json
$(echo "$insights" | python3 -c "import sys, json; d=json.load(sys.stdin).get('status_distribution', {}); print(json.dumps(d, indent=2))")
\`\`\`

## Top Failure Patterns

$(echo "$insights" | python3 -c "
import sys, json
data = json.load(sys.stdin)
patterns = data.get('top_failure_patterns', [])
if patterns:
    for p in patterns[:5]:
        print(f\"### {p['pattern_type']}\")
        print(f\"- **Frequency:** {p['frequency']}\")
        print(f\"- **Description:** {p['description']}\")
        if p.get('suggested_fix'):
            print(f\"- **Suggested fix:** {p['suggested_fix']}\")
        print()
else:
    print('No recurring failure patterns detected.')
")

## Recommendations

$(echo "$insights" | python3 -c "
import sys, json
data = json.load(sys.stdin)
recs = data.get('recommendations', [])
if recs:
    for r in recs:
        print(f'- {r}')
else:
    print('No recommendations at this time.')
")

## Recent Commits

$(echo "$insights" | python3 -c "
import sys, json
data = json.load(sys.stdin)
commits = data.get('recent_commits', [])
for c in commits[:5]:
    print(f\"- \`{c['hash']}\` {c['subject']}\")
")

---

*Auto-generated by RALF Log Ingestor*
EOF

    echo -e "${GREEN}âœ“ Report saved:${NC}"
    echo "  $report_file"
    echo ""
    echo "Quick stats:"
    echo "  Branch: $branch"
    echo "  Success rate: ${success_rate}%"
    echo "  Loops: $total"
}

# Main
case "${1:-}" in
    --weekly|-w)
        generate_report "weekly"
        ;;
    --daily|-d)
        generate_report "daily"
        ;;
    --help|-h)
        echo "RALF Report Generator"
        echo ""
        echo "Usage:"
        echo "  ralf-report --weekly    Generate weekly report"
        echo "  ralf-report --daily     Generate daily report"
        echo ""
        ;;
    *)
        generate_report "weekly"
        ;;
esac
