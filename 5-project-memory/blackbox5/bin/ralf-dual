#!/bin/bash
#
# RALF-Dual Launcher
# Purpose: Start both Planner and Executor agents in parallel
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="${RALF_PROJECT_DIR:-$HOME/.blackbox5/5-project-memory/blackbox5}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${BLUE}[RALF-DUAL]${NC} $*"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $*"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

# Check dependencies
check_deps() {
    local missing=()

    if ! command -v tmux &> /dev/null; then
        missing+=("tmux")
    fi

    if ! command -v yq &> /dev/null; then
        missing+=("yq")
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        error "Missing dependencies: ${missing[*]}"
        error "Install with: brew install tmux yq"
        exit 1
    fi
}

# Check communication files exist
init_communications() {
    local comm_dir="$PROJECT_DIR/.autonomous/communications"

    if [[ ! -d "$comm_dir" ]]; then
        log "Creating communications directory..."
        mkdir -p "$comm_dir"
    fi

    # Create files if they don't exist
    for file in queue.yaml events.yaml chat-log.yaml heartbeat.yaml; do
        if [[ ! -f "$comm_dir/$file" ]]; then
            warn "Creating missing $file"
            touch "$comm_dir/$file"
        fi
    done
}

# Start Planner
start_planner() {
    log "Starting RALF-Planner..."

    if tmux has-session -t ralf-planner 2>/dev/null; then
        warn "Planner session already exists, attaching..."
        return
    fi

    tmux new-session -d -s ralf-planner \
        -n planner \
        "cd '$PROJECT_DIR' && export RALF_MODE=plan && export RALF_PROJECT_DIR='$PROJECT_DIR' && '$SCRIPT_DIR/ralf-planner' 2>&1 | tee -a '$PROJECT_DIR/.autonomous/planner.log'"

    success "Planner started in tmux session 'ralf-planner'"
}

# Start Executor
start_executor() {
    log "Starting RALF-Executor..."

    if tmux has-session -t ralf-executor 2>/dev/null; then
        warn "Executor session already exists, attaching..."
        return
    fi

    tmux new-session -d -s ralf-executor \
        -n executor \
        "cd '$PROJECT_DIR' && export RALF_MODE=execute && export RALF_PROJECT_DIR='$PROJECT_DIR' && '$SCRIPT_DIR/ralf-executor' 2>&1 | tee -a '$PROJECT_DIR/.autonomous/executor.log'"

    success "Executor started in tmux session 'ralf-executor'"
}

# Stop both agents
stop_agents() {
    log "Stopping RALF agents..."

    if tmux has-session -t ralf-planner 2>/dev/null; then
        tmux send-keys -t ralf-planner C-c
        sleep 1
        tmux kill-session -t ralf-planner 2>/dev/null || true
        log "Planner stopped"
    fi

    if tmux has-session -t ralf-executor 2>/dev/null; then
        tmux send-keys -t ralf-executor C-c
        sleep 1
        tmux kill-session -t ralf-executor 2>/dev/null || true
        log "Executor stopped"
    fi

    success "Both agents stopped"
}

# Show status
show_status() {
    log "RALF-Dual Status:"
    echo ""

    # Check tmux sessions
    if tmux has-session -t ralf-planner 2>/dev/null; then
        success "Planner: RUNNING (tmux session: ralf-planner)"
    else
        error "Planner: STOPPED"
    fi

    if tmux has-session -t ralf-executor 2>/dev/null; then
        success "Executor: RUNNING (tmux session: ralf-executor)"
    else
        error "Executor: STOPPED"
    fi

    echo ""

    # Show queue depth
    local queue_file="$PROJECT_DIR/.autonomous/communications/queue.yaml"
    if [[ -f "$queue_file" ]]; then
        local depth
        depth=$(yq '.queue | length' "$queue_file" 2>/dev/null || echo "0")
        log "Queue depth: $depth tasks"
    fi

    # Show last heartbeat
    local heartbeat_file="$PROJECT_DIR/.autonomous/communications/heartbeat.yaml"
    if [[ -f "$heartbeat_file" ]]; then
        local planner_status executor_status
        planner_status=$(yq '.heartbeats.planner.status' "$heartbeat_file" 2>/dev/null || echo "unknown")
        executor_status=$(yq '.heartbeats.executor.status' "$heartbeat_file" 2>/dev/null || echo "unknown")
        log "Planner status: $planner_status"
        log "Executor status: $executor_status"
    fi
}

# Attach to session
attach() {
    local session="$1"

    if [[ "$session" == "planner" ]]; then
        tmux attach -t ralf-planner
    elif [[ "$session" == "executor" ]]; then
        tmux attach -t ralf-executor
    else
        error "Unknown session: $session (use 'planner' or 'executor')"
        exit 1
    fi
}

# Show logs
show_logs() {
    local agent="${1:-both}"

    if [[ "$agent" == "planner" || "$agent" == "both" ]]; then
        log "=== Planner Logs ==="
        tail -50 "$PROJECT_DIR/.autonomous/planner.log" 2>/dev/null || echo "No planner logs"
        echo ""
    fi

    if [[ "$agent" == "executor" || "$agent" == "both" ]]; then
        log "=== Executor Logs ==="
        tail -50 "$PROJECT_DIR/.autonomous/executor.log" 2>/dev/null || echo "No executor logs"
    fi
}

# Show help
show_help() {
    cat << EOF
RALF-Dual: Parallel Agent Launcher

Usage: ralf-dual [command] [options]

Commands:
    start           Start both Planner and Executor
    stop            Stop both agents
    restart         Restart both agents
    status          Show current status
    attach [agent]  Attach to tmux session (planner|executor)
    logs [agent]    Show logs (planner|executor|both)
    help            Show this help

Examples:
    ralf-dual start              # Start both agents
    ralf-dual status             # Check status
    ralf-dual attach planner     # Watch Planner
    ralf-dual logs executor      # Show Executor logs
    ralf-dual stop               # Stop everything

Environment Variables:
    RALF_PROJECT_DIR    Project directory (default: ~/.blackbox5/5-project-memory/blackbox5)

EOF
}

# Main
case "${1:-help}" in
    start)
        check_deps
        init_communications
        start_planner
        sleep 2
        start_executor
        echo ""
        success "RALF-Dual is running!"
        log "View status: ralf-dual status"
        log "Attach to Planner: ralf-dual attach planner"
        log "Attach to Executor: ralf-dual attach executor"
        log "Stop: ralf-dual stop"
        ;;

    stop)
        stop_agents
        ;;

    restart)
        stop_agents
        sleep 2
        check_deps
        init_communications
        start_planner
        sleep 2
        start_executor
        ;;

    status)
        show_status
        ;;

    attach)
        attach "${2:-planner}"
        ;;

    logs)
        show_logs "${2:-both}"
        ;;

    help|--help|-h)
        show_help
        ;;

    *)
        error "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
