#!/bin/bash
# bb5-goto - Navigation commands (up, down, root, goto)
# Usage: bb5 up | bb5 down [ID] | bb5 root | bb5 goto [ID]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BLACKBOX5_DIR="$PROJECT_ROOT/5-project-memory/blackbox5"

COMMAND="${1:-}"
TARGET="${2:-}"

# Get current context
CONTEXT=$("$SCRIPT_DIR/bb5-discover-context" json)
CURRENT_TYPE=$(echo "$CONTEXT" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')
CURRENT_ID=$(echo "$CONTEXT" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')
PARENT_PLAN=$(echo "$CONTEXT" | grep '"parent_plan"' | sed 's/.*: "\([^"]*\)".*/\1/')
PARENT_GOAL=$(echo "$CONTEXT" | grep '"parent_goal"' | sed 's/.*: "\([^"]*\)".*/\1/')

case "$COMMAND" in
    up)
        # Navigate up one level
        case "$CURRENT_TYPE" in
            task)
                if [ -n "$PARENT_PLAN" ] && [ "$PARENT_PLAN" != "null" ]; then
                    PLAN_DIR="$BLACKBOX5_DIR/plans/active/$PARENT_PLAN"
                    if [ -d "$PLAN_DIR" ]; then
                        echo "cd $PLAN_DIR"
                        cd "$PLAN_DIR"
                        echo "✓ Moved up to plan: $PARENT_PLAN"
                    else
                        echo "Parent plan not found: $PARENT_PLAN"
                        exit 1
                    fi
                else
                    echo "No parent plan found for task: $CURRENT_ID"
                    exit 1
                fi
                ;;
            plan)
                if [ -n "$PARENT_GOAL" ] && [ "$PARENT_GOAL" != "null" ]; then
                    GOAL_DIR="$BLACKBOX5_DIR/goals/active/$PARENT_GOAL"
                    if [ -d "$GOAL_DIR" ]; then
                        echo "cd $GOAL_DIR"
                        cd "$GOAL_DIR"
                        echo "✓ Moved up to goal: $PARENT_GOAL"
                    else
                        echo "Parent goal not found: $PARENT_GOAL"
                        exit 1
                    fi
                else
                    echo "No parent goal found for plan: $CURRENT_ID"
                    exit 1
                fi
                ;;
            goal)
                echo "Already at goal level. Use 'bb5 root' to go to project root."
                exit 1
                ;;
            *)
                echo "Not in goals/plans/tasks hierarchy. Current: $CURRENT_TYPE"
                exit 1
                ;;
        esac
        ;;

    down)
        # Navigate down to specific child
        if [ -z "$TARGET" ]; then
            echo "Usage: bb5 down [ID]"
            echo ""
            echo "Available children:"
            case "$CURRENT_TYPE" in
                goal)
                    if [ -d "$BLACKBOX5_DIR/goals/active/$CURRENT_ID/plans" ]; then
                        ls -1 "$BLACKBOX5_DIR/goals/active/$CURRENT_ID/plans" 2>/dev/null || echo "  No linked plans"
                    fi
                    ;;
                plan)
                    if [ -d "$BLACKBOX5_DIR/plans/active/$CURRENT_ID/tasks" ]; then
                        ls -1 "$BLACKBOX5_DIR/plans/active/$CURRENT_ID/tasks" 2>/dev/null || echo "  No linked tasks"
                    fi
                    ;;
                task)
                    if [ -d "$BLACKBOX5_DIR/tasks/active/$CURRENT_ID/subtasks" ]; then
                        ls -1 "$BLACKBOX5_DIR/tasks/active/$CURRENT_ID/subtasks" 2>/dev/null || echo "  No subtasks"
                    fi
                    ;;
            esac
            exit 1
        fi

        case "$CURRENT_TYPE" in
            goal)
                PLAN_LINK="$BLACKBOX5_DIR/goals/active/$CURRENT_ID/plans/$TARGET"
                if [ -L "$PLAN_LINK" ]; then
                    PLAN_DIR=$(readlink -f "$PLAN_LINK" 2>/dev/null || readlink "$PLAN_LINK")
                    if [ -d "$PLAN_DIR" ]; then
                        echo "cd $PLAN_DIR"
                        cd "$PLAN_DIR"
                        echo "✓ Moved down to plan: $TARGET"
                    else
                        echo "Plan directory not found: $PLAN_DIR"
                        exit 1
                    fi
                else
                    echo "Plan not linked to this goal: $TARGET"
                    exit 1
                fi
                ;;
            plan)
                TASK_LINK="$BLACKBOX5_DIR/plans/active/$CURRENT_ID/tasks/$TARGET"
                if [ -L "$TASK_LINK" ]; then
                    TASK_DIR=$(readlink -f "$TASK_LINK" 2>/dev/null || readlink "$TASK_LINK")
                    if [ -d "$TASK_DIR" ]; then
                        echo "cd $TASK_DIR"
                        cd "$TASK_DIR"
                        echo "✓ Moved down to task: $TARGET"
                    else
                        echo "Task directory not found: $TASK_DIR"
                        exit 1
                    fi
                else
                    echo "Task not linked to this plan: $TARGET"
                    exit 1
                fi
                ;;
            task)
                SUBTASK_DIR="$BLACKBOX5_DIR/tasks/active/$CURRENT_ID/subtasks/$TARGET"
                if [ -d "$SUBTASK_DIR" ]; then
                    echo "cd $SUBTASK_DIR"
                    cd "$SUBTASK_DIR"
                    echo "✓ Moved down to subtask: $TARGET"
                else
                    echo "Subtask not found: $TARGET"
                    exit 1
                fi
                ;;
            *)
                echo "Not in a navigable hierarchy. Current: $CURRENT_TYPE"
                exit 1
                ;;
        esac
        ;;

    root)
        # Go to project root
        echo "cd $BLACKBOX5_DIR"
        cd "$BLACKBOX5_DIR"
        echo "✓ Moved to project root"
        ;;

    goto)
        # Jump to specific item by ID
        if [ -z "$TARGET" ]; then
            echo "Usage: bb5 goto [GOAL|PLAN|TASK]-ID"
            exit 1
        fi

        # Determine type from ID prefix
        if echo "$TARGET" | grep -qE '^IG-[0-9]+$'; then
            # It's a goal
            GOAL_DIR="$BLACKBOX5_DIR/goals/active/$TARGET"
            if [ -d "$GOAL_DIR" ]; then
                echo "cd $GOAL_DIR"
                cd "$GOAL_DIR"
                echo "✓ Jumped to goal: $TARGET"
            else
                echo "Goal not found: $TARGET"
                exit 1
            fi
        elif echo "$TARGET" | grep -qE '^TASK-[0-9]+$'; then
            # It's a task
            TASK_DIR="$BLACKBOX5_DIR/tasks/active/$TARGET"
            if [ -d "$TASK_DIR" ]; then
                echo "cd $TASK_DIR"
                cd "$TASK_DIR"
                echo "✓ Jumped to task: $TARGET"
            else
                echo "Task not found: $TARGET"
                exit 1
            fi
        else
            # Assume it's a plan name
            PLAN_DIR="$BLACKBOX5_DIR/plans/active/$TARGET"
            if [ -d "$PLAN_DIR" ]; then
                echo "cd $PLAN_DIR"
                cd "$PLAN_DIR"
                echo "✓ Jumped to plan: $TARGET"
            else
                echo "Unknown ID format: $TARGET"
                echo "Expected: IG-XXX (goal), TASK-XXX (task), or plan name"
                exit 1
            fi
        fi
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo "Usage:"
        echo "  bb5 up              # Go up one level"
        echo "  bb5 down [ID]       # Go down to child"
        echo "  bb5 root            # Go to project root"
        echo "  bb5 goto [ID]       # Jump to specific item"
        exit 1
        ;;
esac
