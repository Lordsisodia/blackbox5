#!/bin/bash
# bb5-goal - Goal management commands
# Usage: bb5 goal:list | bb5 goal:show [GOAL-ID]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BLACKBOX5_DIR="$PROJECT_ROOT/5-project-memory/blackbox5"
GOALS_DIR="$BLACKBOX5_DIR/goals/active"

COMMAND="${1:-list}"
GOAL_ID="${2:-}"

# Colors
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    NC=''
fi

case "$COMMAND" in
    list)
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Active Goals"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        if [ ! -d "$GOALS_DIR" ]; then
            echo "No goals directory found at $GOALS_DIR"
            exit 1
        fi

        # Count goals
        GOAL_COUNT=$(ls -1 "$GOALS_DIR" 2>/dev/null | grep -c '^IG-' || echo "0")

        if [ "$GOAL_COUNT" -eq 0 ]; then
            echo "No active goals found."
            echo ""
            echo "Create a goal with:"
            echo "  bb5 goal:create 'Goal Name'"
        else
            for goal_dir in "$GOALS_DIR"/IG-*/; do
                if [ -d "$goal_dir" ]; then
                    goal_id=$(basename "$goal_dir")
                    goal_file="$goal_dir/goal.yaml"

                    if [ -f "$goal_file" ]; then
                        # Extract goal info using grep/sed
                        goal_name=$(grep "^name:" "$goal_file" | sed 's/name: "\(.*\)"/\1/' | head -1)
                        goal_status=$(grep "status:" "$goal_file" | sed 's/.*status: \(.*\)/\1/' | head -1)
                        goal_priority=$(grep "priority:" "$goal_file" | sed 's/.*priority: \(.*\)/\1/' | head -1)

                        # Color code by status
                        status_color="$NC"
                        case "$goal_status" in
                            completed) status_color="$GREEN" ;;
                            in_progress) status_color="$YELLOW" ;;
                            blocked) status_color="\033[0;31m" ;;
                        esac

                        printf "${CYAN}%s${NC} - %s\n" "$goal_id" "$goal_name"
                        printf "  Status: ${status_color}%s${NC} | Priority: %s\n" "$goal_status" "$goal_priority"

                        # Count linked plans
                        plan_count=$(ls -1 "$goal_dir/plans" 2>/dev/null | wc -l)
                        if [ "$plan_count" -gt 0 ]; then
                            printf "  Plans: %d linked\n" "$plan_count"
                        fi
                        echo ""
                    fi
                fi
            done

            echo "═══════════════════════════════════════════════════════════════"
            echo "Total: $GOAL_COUNT active goal(s)"
            echo "═══════════════════════════════════════════════════════════════"
        fi
        ;;

    show)
        if [ -z "$GOAL_ID" ]; then
            # Try to detect current goal
            CONTEXT=$("$SCRIPT_DIR/bb5-discover-context" json)
            CURRENT_TYPE=$(echo "$CONTEXT" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')

            if [ "$CURRENT_TYPE" = "goal" ]; then
                GOAL_ID=$(echo "$CONTEXT" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')
            else
                echo "Usage: bb5 goal:show [GOAL-ID]"
                echo "Or run from within a goal directory"
                exit 1
            fi
        fi

        GOAL_DIR="$GOALS_DIR/$GOAL_ID"

        if [ ! -d "$GOAL_DIR" ]; then
            echo "Goal not found: $GOAL_ID"
            echo ""
            echo "Available goals:"
            "$SCRIPT_DIR/bb5-goal" list
            exit 1
        fi

        GOAL_FILE="$GOAL_DIR/goal.yaml"

        if [ ! -f "$GOAL_FILE" ]; then
            echo "Goal file not found: $GOAL_FILE"
            exit 1
        fi

        echo "═══════════════════════════════════════════════════════════════"
        printf "  ${CYAN}Goal: %s${NC}\n" "$GOAL_ID"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        # Display goal.yaml content (formatted)
        if command -v yq >/dev/null 2>&1; then
            # Use yq if available
            yq eval '.' "$GOAL_FILE" 2>/dev/null || cat "$GOAL_FILE"
        else
            # Fallback: just show the file
            cat "$GOAL_FILE"
        fi

        echo ""
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Linked Plans"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        if [ -d "$GOAL_DIR/plans" ]; then
            PLAN_COUNT=$(ls -1 "$GOAL_DIR/plans" 2>/dev/null | wc -l)
            if [ "$PLAN_COUNT" -gt 0 ]; then
                for plan_link in "$GOAL_DIR/plans"/*; do
                    if [ -L "$plan_link" ]; then
                        plan_name=$(basename "$plan_link")
                        plan_target=$(readlink "$plan_link")
                        printf "  • %s → %s\n" "$plan_name" "$plan_target"
                    fi
                done
            else
                echo "  No plans linked to this goal."
                echo ""
                echo "  Link a plan:"
                echo "    bb5 link:plan [PLAN-NAME]"
            fi
        else
            echo "  No plans directory found."
        fi

        echo ""
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Navigation"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""
        echo "  cd $GOAL_DIR"
        echo "  bb5 plan:list"
        echo "  bb5 plan:create 'New Plan'"
        echo ""
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo "Usage: bb5 goal:list | bb5 goal:show [GOAL-ID]"
        exit 1
        ;;
esac
