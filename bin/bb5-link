#!/bin/bash
# bb5-link - Linking commands for goals, plans, and tasks
# Usage: bb5-link [goal|plan|task] [ID]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BLACKBOX5_DIR="$PROJECT_ROOT/5-project-memory/blackbox5"

COMMAND="${1:-}"
TARGET_ID="${2:-}"

# Colors
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    NC=''
fi

# Get current context
CONTEXT=$("$SCRIPT_DIR/bb5-discover-context" json)
CURRENT_TYPE=$(echo "$CONTEXT" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')
CURRENT_ID=$(echo "$CONTEXT" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')

case "$COMMAND" in
    goal)
        if [ -z "$TARGET_ID" ]; then
            echo "Usage: bb5 link:goal [GOAL-ID]"
            echo ""
            echo "Available goals:"
            "$SCRIPT_DIR/bb5-goal" list
            exit 1
        fi

        # Validate goal exists
        GOAL_DIR="$BLACKBOX5_DIR/goals/active/$TARGET_ID"
        if [ ! -d "$GOAL_DIR" ]; then
            echo "Goal not found: $TARGET_ID"
            exit 1
        fi

        # Link current item to goal
        case "$CURRENT_TYPE" in
            plan)
                # Create symlink in goal/plans/
                mkdir -p "$GOAL_DIR/plans"
                PLAN_NAME="$CURRENT_ID"
                CURRENT_DIR="$BLACKBOX5_DIR/plans/active/$CURRENT_ID"

                # Calculate relative path from goal to plan
                RELATIVE_PATH="$(realpath --relative-to="$GOAL_DIR/plans" "$CURRENT_DIR" 2>/dev/null || echo "../../../plans/active/$PLAN_NAME")"

                ln -sf "$RELATIVE_PATH" "$GOAL_DIR/plans/$PLAN_NAME"

                echo ""
                echo "═══════════════════════════════════════════════════════════════"
                printf "  ${GREEN}✓ Linked plan to goal${NC}\n"
                echo "═══════════════════════════════════════════════════════════════"
                echo ""
                echo "Plan: $CURRENT_ID"
                echo "Goal: $TARGET_ID"
                echo ""
                echo "Goal now shows this plan when you run:"
                echo "  bb5 goal:show $TARGET_ID"
                echo ""
                ;;

            task)
                # Tasks can't directly link to goals, must go through plan
                echo "Tasks should be linked to plans, not directly to goals."
                echo ""
                echo "To link this task:"
                echo "  1. Link task to a plan: bb5 link:plan [PLAN-ID]"
                echo "  2. Link that plan to this goal: bb5 link:goal $TARGET_ID"
                echo ""
                ;;

            *)
                echo "Cannot link $CURRENT_TYPE to goal"
                echo "Only plans can be linked to goals."
                exit 1
                ;;
        esac
        ;;

    plan)
        if [ -z "$TARGET_ID" ]; then
            echo "Usage: bb5 link:plan [PLAN-ID]"
            echo ""
            echo "Available plans:"
            "$SCRIPT_DIR/bb5-plan" list
            exit 1
        fi

        # Validate plan exists
        PLAN_DIR="$BLACKBOX5_DIR/plans/active/$TARGET_ID"
        if [ ! -d "$PLAN_DIR" ]; then
            echo "Plan not found: $TARGET_ID"
            exit 1
        fi

        # Link current item to plan
        case "$CURRENT_TYPE" in
            task)
                # Create symlink in plan/tasks/
                mkdir -p "$PLAN_DIR/tasks"
                TASK_NAME="$CURRENT_ID"
                CURRENT_DIR="$BLACKBOX5_DIR/tasks/active/$CURRENT_ID"

                # Calculate relative path from plan to task
                RELATIVE_PATH="$(realpath --relative-to="$PLAN_DIR/tasks" "$CURRENT_DIR" 2>/dev/null || echo "../../../tasks/active/$TASK_NAME")"

                ln -sf "$RELATIVE_PATH" "$PLAN_DIR/tasks/$TASK_NAME"

                # Also update task.md with parent plan reference
                TASK_FILE="$CURRENT_DIR/task.md"
                if [ -f "$TASK_FILE" ]; then
                    # Add linked_plan to frontmatter if not present
                    if ! grep -q "linked_plan:" "$TASK_FILE"; then
                        # Insert after the first ---
                        sed -i '' '/^---$/,/^---$/{/^---$/a\
linked_plan: '"$TARGET_ID"'\
}' "$TASK_FILE" 2>/dev/null || true
                    fi
                fi

                echo ""
                echo "═══════════════════════════════════════════════════════════════"
                printf "  ${GREEN}✓ Linked task to plan${NC}\n"
                echo "═══════════════════════════════════════════════════════════════"
                echo ""
                echo "Task: $CURRENT_ID"
                echo "Plan: $TARGET_ID"
                echo ""
                echo "Plan now shows this task when you run:"
                echo "  bb5 plan:show $TARGET_ID"
                echo ""
                ;;

            *)
                echo "Cannot link $CURRENT_TYPE to plan"
                echo "Only tasks can be linked to plans."
                exit 1
                ;;
        esac
        ;;

    task)
        if [ -z "$TARGET_ID" ]; then
            echo "Usage: bb5 link:task [TASK-ID]"
            exit 1
        fi

        echo "Tasks are automatically linked to their parent task when created as subtasks."
        echo ""
        echo "To create a subtask:"
        echo "  cd $BLACKBOX5_DIR/tasks/active/$TARGET_ID"
        echo "  bb5 subtask:create 'Subtask Name'"
        echo ""
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo "Usage:"
        echo "  bb5 link:goal [GOAL-ID]    # Link current plan to goal"
        echo "  bb5 link:plan [PLAN-ID]    # Link current task to plan"
        echo "  bb5 link:task [TASK-ID]    # (Info only - use subtask:create)"
        exit 1
        ;;
esac
