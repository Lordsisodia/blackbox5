#!/bin/bash
#
# RALF-Executor v2
# Purpose: Task execution agent using v2-legacy-based.md prompt
# Runs: Continuously in background, invokes Claude Code
#

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Auto-detect if running in GitHub Codespace
if [[ -n "${CODESPACE_NAME:-}" ]] || [[ -d "/workspaces/blackbox5" ]]; then
    # GitHub Codespace environment
    BASE_DIR="/workspaces/blackbox5"
    # Set up API key for Claude if available
    if [[ -f "$HOME/.anthropic_api_key" ]]; then
        export ANTHROPIC_API_KEY=$(cat "$HOME/.anthropic_api_key")
    fi
    # Set base URL if using proxy (e.g., api.z.ai)
    if [[ -n "${ANTHROPIC_BASE_URL:-}" ]]; then
        export ANTHROPIC_BASE_URL
    elif [[ -f "$HOME/.anthropic_base_url" ]]; then
        export ANTHROPIC_BASE_URL=$(cat "$HOME/.anthropic_base_url")
    fi
else
    # Local environment
    BASE_DIR="${RALF_BASE_DIR:-$HOME/.blackbox5}"
fi

PROJECT_DIR="${RALF_PROJECT_DIR:-$BASE_DIR/5-project-memory/blackbox5}"
ENGINE_DIR="${RALF_ENGINE_DIR:-$BASE_DIR/2-engine/.autonomous}"
PROMPT_FILE="$ENGINE_DIR/prompts/system/executor/variations/v2-legacy-based.md"
COMM_DIR="$PROJECT_DIR/.autonomous/communications"
RUNS_DIR="$PROJECT_DIR/runs/executor"

# Logging
LOG_FILE="$PROJECT_DIR/.autonomous/executor-v2.log"
RUN_COUNTER=0

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [EXECUTOR-v2] $*" | tee -a "$LOG_FILE"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [EXECUTOR-v2] ERROR: $*" | tee -a "$LOG_FILE" >&2
}

# Initialize run directory
init_run() {
    RUN_COUNTER=$((RUN_COUNTER + 1))
    local run_dir="$RUNS_DIR/run-$(printf %04d $RUN_COUNTER)"
    mkdir -p "$run_dir"
    export RALF_RUN_DIR="$run_dir"
    echo "$run_dir"
}

# Read current state for context
read_state() {
    local queue="{}"
    local events="{}"
    local heartbeat="{}"
    local chat="{}"

    if [[ -f "$COMM_DIR/queue.yaml" ]]; then
        queue=$(cat "$COMM_DIR/queue.yaml" 2>/dev/null || echo "{}")
    fi

    if [[ -f "$COMM_DIR/events.yaml" ]]; then
        events=$(cat "$COMM_DIR/events.yaml" 2>/dev/null | tail -20 || echo "{}")
    fi

    if [[ -f "$COMM_DIR/heartbeat.yaml" ]]; then
        heartbeat=$(cat "$COMM_DIR/heartbeat.yaml" 2>/dev/null || echo "{}")
    fi

    if [[ -f "$COMM_DIR/chat-log.yaml" ]]; then
        chat=$(cat "$COMM_DIR/chat-log.yaml" 2>/dev/null | tail -20 || echo "{}")
    fi

    echo "QUEUE: $queue"
    echo "EVENTS: $events"
    echo "HEARTBEAT: $heartbeat"
    echo "CHAT: $chat"
}

# Update heartbeat
update_heartbeat() {
    local status="$1"
    local action="${2:-idle}"

    python3 << PYEOF
import yaml
from datetime import datetime, timezone

heartbeat_file = "$COMM_DIR/heartbeat.yaml"

try:
    with open(heartbeat_file, 'r') as f:
        data = yaml.safe_load(f) or {}
except FileNotFoundError:
    data = {}

if not isinstance(data, dict):
    data = {}
if "heartbeats" not in data:
    data["heartbeats"] = {}
if "executor" not in data["heartbeats"]:
    data["heartbeats"]["executor"] = {}

now = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

data["heartbeats"]["executor"]["last_seen"] = now
data["heartbeats"]["executor"]["status"] = "$status"
data["heartbeats"]["executor"]["current_action"] = "$action"

with open(heartbeat_file, 'w') as f:
    yaml.dump(data, f, default_flow_style=False, sort_keys=False)
PYEOF
}

# Main execution - invoke Claude
run_claude() {
    local run_dir="$1"
    local state_context
    state_context=$(read_state)

    log "Invoking Claude Code for execution..."

    # Build the full prompt
    local full_prompt
    full_prompt=$(cat << EOF
$(cat "$PROMPT_FILE")

---

## CURRENT STATE

Run directory: $run_dir

State Context:
$state_context

Project Directory: $PROJECT_DIR
Engine Directory: $ENGINE_DIR

## YOUR TASK

Execute ONE execution iteration:
1. Check tasks/active/ for pending tasks
2. If task available: Claim it, execute it, document it, commit it, move to completed/
3. If no tasks: Find work - check feedback/, analyze runs/, organize insights/
4. Write your THOUGHTS.md, RESULTS.md, DECISIONS.md to the run directory
5. Update events.yaml and heartbeat.yaml
6. Signal completion (COMPLETE, RETRY, BLOCKED, FAILED, or PARTIAL)

Do not loop - this is one iteration. The bash script will handle the loop.
EOF
)

    # Debug: Log prompt size
    log "Prompt size: ${#full_prompt} characters"

    # Invoke Claude Code with debug output - write directly to log
    log "Starting Claude invocation at $(date '+%Y-%m-%d %H:%M:%S')"
    if echo "$full_prompt" | claude -p \
        --dangerously-skip-permissions \
        --allowed-tools "Read,Edit,Bash,Write" \
        2>&1 >> "$LOG_FILE"; then
        log "Claude invocation completed at $(date '+%Y-%m-%d %H:%M:%S')"
    else
        error "Claude invocation failed at $(date '+%Y-%m-%d %H:%M:%S')"
    fi
}

# Main loop
main() {
    log "RALF-Executor v2 starting..."
    log "Project: $PROJECT_DIR"
    log "Prompt: $PROMPT_FILE"

    # Check prompt file exists
    if [[ ! -f "$PROMPT_FILE" ]]; then
        error "Prompt file not found: $PROMPT_FILE"
        exit 1
    fi

    # Create directories
    mkdir -p "$RUNS_DIR"
    mkdir -p "$COMM_DIR"

    while true; do
        log "--- Starting iteration ---"

        # Initialize run
        local run_dir
        run_dir=$(init_run)
        log "Run directory: $run_dir"

        # Update heartbeat
        update_heartbeat "running" "executing"

        # Run Claude
        run_claude "$run_dir"

        # Update heartbeat
        update_heartbeat "running" "sleeping"

        log "--- Iteration complete, sleeping 30s ---"
        sleep 30
    done
}

# Handle shutdown
cleanup() {
    log "Shutting down..."
    update_heartbeat "stopped" "shutdown"
    exit 0
}

trap cleanup SIGINT SIGTERM

# Run
main "$@"
