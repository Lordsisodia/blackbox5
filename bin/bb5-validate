#!/bin/bash
# bb5-validate - Validation CLI command for BlackBox5
# Usage: bb5 validate docs [RUN-DIR] | bb5 validate task [TASK-ID] | bb5 validate ssot | bb5 validate skills | bb5 validate all
#
# Exit Codes:
#   0 = All validations passed
#   1 = One or more validations failed

set -e

# Source dry-run utility library
source "$(dirname "$0")/../2-engine/.autonomous/lib/dry_run.sh" 2>/dev/null || true

# =============================================================================
# CONFIGURATION
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BLACKBOX5_DIR="$PROJECT_ROOT/5-project-memory/blackbox5"

# Colors
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    RED='\033[0;31m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    GREEN=''
    YELLOW=''
    RED=''
    CYAN=''
    NC=''
fi

# =============================================================================
# VALIDATION STATE
# =============================================================================

ERRORS=0
WARNINGS=0

# =============================================================================
# UTILITY FUNCTIONS
# =============================================================================

log_info() {
    echo -e "${CYAN}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[PASS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    ((WARNINGS++)) || true
}

log_error() {
    echo -e "${RED}[FAIL]${NC} $1"
    ((ERRORS++)) || true
}

# =============================================================================
# VALIDATE DOCS
# =============================================================================

validate_docs() {
    local run_dir="${1:-}"

    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  Validating Run Documentation"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""

    # Determine run directory
    if [ -z "$run_dir" ]; then
        # Try to detect from context
        local context
        context=$("$SCRIPT_DIR/bb5-discover-context" json 2>/dev/null || echo '{}')
        local current_type
        current_type=$(echo "$context" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')

        if [ "$current_type" = "run" ]; then
            local current_path
            current_path=$(echo "$context" | grep '"current_path"' | sed 's/.*: "\([^"]*\)".*/\1/')
            run_dir="$BLACKBOX5_DIR$current_path"
        elif [ "$current_type" = "task" ]; then
            local current_id
            current_id=$(echo "$context" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')
            # Look for run directories in the task
            local task_dir="$BLACKBOX5_DIR/tasks/active/$current_id"
            if [ -d "$task_dir/runs" ]; then
                run_dir=$(find "$task_dir/runs" -maxdepth 1 -type d | sort | tail -1)
            fi
        fi
    fi

    # If still no run_dir, check if we're in a run directory
    if [ -z "$run_dir" ] && [ -f "THOUGHTS.md" ] && [ -f "RESULTS.md" ]; then
        run_dir="$(pwd)"
    fi

    if [ -z "$run_dir" ] || [ ! -d "$run_dir" ]; then
        log_error "Run directory not found. Please specify a run directory or run from within a run folder."
        return 1
    fi

    log_info "Validating docs in: $run_dir"
    echo ""

    local local_errors=0

    # Check THOUGHTS.md
    if [ -f "$run_dir/THOUGHTS.md" ]; then
        local thoughts_size
        thoughts_size=$(wc -c < "$run_dir/THOUGHTS.md" | tr -d ' ')
        if [ "$thoughts_size" -gt 500 ]; then
            log_success "THOUGHTS.md exists with content (${thoughts_size} chars)"
        else
            log_error "THOUGHTS.md exists but content too short (${thoughts_size} chars, expected >500)"
            ((local_errors++)) || true
        fi
    else
        log_error "THOUGHTS.md is missing"
        ((local_errors++)) || true
    fi

    # Check RESULTS.md
    if [ -f "$run_dir/RESULTS.md" ]; then
        if grep -q "status:" "$run_dir/RESULTS.md" 2>/dev/null || \
           grep -q "Status:" "$run_dir/RESULTS.md" 2>/dev/null || \
           grep -q -i "complete\|success\|failed\|blocked" "$run_dir/RESULTS.md" 2>/dev/null; then
            log_success "RESULTS.md exists with status"
        else
            log_warning "RESULTS.md exists but no status found"
        fi
    else
        log_error "RESULTS.md is missing"
        ((local_errors++)) || true
    fi

    # Check DECISIONS.md
    if [ -f "$run_dir/DECISIONS.md" ]; then
        log_success "DECISIONS.md exists"
    else
        log_error "DECISIONS.md is missing"
        ((local_errors++)) || true
    fi

    # Check LEARNINGS.md
    if [ -f "$run_dir/LEARNINGS.md" ]; then
        log_success "LEARNINGS.md exists"
    else
        log_error "LEARNINGS.md is missing"
        ((local_errors++)) || true
    fi

    # Check ASSUMPTIONS.md (optional but recommended)
    if [ -f "$run_dir/ASSUMPTIONS.md" ]; then
        log_success "ASSUMPTIONS.md exists"
    else
        log_warning "ASSUMPTIONS.md is missing (optional but recommended)"
    fi

    echo ""
    if [ "$local_errors" -eq 0 ]; then
        log_success "Documentation validation passed"
        return 0
    else
        log_error "Documentation validation failed with $local_errors error(s)"
        return 1
    fi
}

# =============================================================================
# VALIDATE TASK
# =============================================================================

validate_task() {
    local task_id="${1:-}"

    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  Validating Task Completeness"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""

    # Determine task ID
    if [ -z "$task_id" ]; then
        # Try to detect from context
        local context
        context=$("$SCRIPT_DIR/bb5-discover-context" json 2>/dev/null || echo '{}')
        local current_type
        current_type=$(echo "$context" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')

        if [ "$current_type" = "task" ]; then
            task_id=$(echo "$context" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')
        fi
    fi

    # If still no task_id, check if we're in a task directory
    if [ -z "$task_id" ] && [ -f "task.md" ]; then
        task_id=$(basename "$(pwd)")
    fi

    if [ -z "$task_id" ]; then
        log_error "Task ID not found. Please specify a task ID or run from within a task folder."
        return 1
    fi

    local task_dir="$BLACKBOX5_DIR/tasks/active/$task_id"

    if [ ! -d "$task_dir" ]; then
        log_error "Task directory not found: $task_dir"
        return 1
    fi

    log_info "Validating task: $task_id"
    echo ""

    local local_errors=0

    # Check task.md exists
    if [ -f "$task_dir/task.md" ]; then
        log_success "task.md exists"
    else
        log_error "task.md is missing"
        ((local_errors++)) || true
    fi

    # Check acceptance criteria documented
    if [ -f "$task_dir/task.md" ]; then
        if grep -q -i "success criteria\|acceptance criteria\|## Criteria" "$task_dir/task.md" 2>/dev/null; then
            log_success "Acceptance/Success criteria documented"
        else
            log_warning "No acceptance criteria section found in task.md"
        fi
    fi

    # Check task has been claimed
    if [ -f "$task_dir/.claimed" ]; then
        local claimer
        claimer=$(cat "$task_dir/.claimed" 2>/dev/null || echo "unknown")
        log_success "Task is claimed by: $claimer"
    else
        log_warning "Task has not been claimed (no .claimed file)"
    fi

    # Check run folder exists
    if [ -d "$task_dir/runs" ]; then
        local run_count
        run_count=$(find "$task_dir/runs" -maxdepth 1 -type d | wc -l)
        run_count=$((run_count - 1))  # Subtract the runs directory itself
        if [ "$run_count" -gt 0 ]; then
            log_success "Run folder exists with $run_count run(s)"
        else
            log_warning "Run folder exists but is empty"
        fi
    else
        log_warning "No run folder found (task may not have been started)"
    fi

    # Check for data layers
    echo ""
    log_info "Checking data layers..."
    for file in THOUGHTS.md DECISIONS.md LEARNINGS.md ASSUMPTIONS.md RESULTS.md; do
        if [ -f "$task_dir/$file" ]; then
            local size
            size=$(wc -l < "$task_dir/$file" | tr -d ' ')
            log_success "$file exists ($size lines)"
        else
            log_warning "$file not in task root (may be in run folders)"
        fi
    done

    echo ""
    if [ "$local_errors" -eq 0 ]; then
        log_success "Task validation passed"
        return 0
    else
        log_error "Task validation failed with $local_errors error(s)"
        return 1
    fi
}

# =============================================================================
# VALIDATE SSOT
# =============================================================================

validate_ssot() {
    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  Validating STATE.yaml Consistency"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""

    # Find validate-ssot.py
    local validator_script="$BLACKBOX5_DIR/bin/validate-ssot.py"

    if [ ! -f "$validator_script" ]; then
        log_error "validate-ssot.py not found at $validator_script"
        return 1
    fi

    # Run the Python validator
    log_info "Running validate-ssot.py..."
    echo ""

    if python3 "$validator_script"; then
        echo ""
        log_success "SSOT validation passed"
        return 0
    else
        echo ""
        log_error "SSOT validation failed"
        return 1
    fi
}

# =============================================================================
# VALIDATE SKILLS
# =============================================================================

validate_skills() {
    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  Validating Skill Usage Logging"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""

    local local_errors=0

    # Check skill-registry.yaml (primary source)
    local skill_registry="$BLACKBOX5_DIR/operations/skill-registry.yaml"
    if [ -f "$skill_registry" ]; then
        log_success "skill-registry.yaml exists"

        # Basic YAML validation
        if python3 -c "import yaml; yaml.safe_load(open('$skill_registry'))" 2>/dev/null; then
            log_success "skill-registry.yaml is valid YAML"
        else
            log_error "skill-registry.yaml has YAML syntax errors"
            ((local_errors++)) || true
        fi
    else
        log_warning "skill-registry.yaml not found"
    fi

    # Check deprecated skill-usage.yaml (for backward compatibility)
    local skill_usage="$BLACKBOX5_DIR/operations/skill-usage.yaml"
    if [ -f "$skill_usage" ]; then
        log_warning "skill-usage.yaml exists but is deprecated (should use skill-registry.yaml)"
    fi

    # Check skill-selection.yaml (for backward compatibility)
    local skill_selection="$BLACKBOX5_DIR/operations/skill-selection.yaml"
    if [ -f "$skill_selection" ]; then
        log_warning "skill-selection.yaml exists but is deprecated (should use skill-registry.yaml)"
    fi

    # Validate skill entries in skill-registry.yaml
    if [ -f "$skill_registry" ]; then
        echo ""
        log_info "Checking skill entries..."

        # Extract skill names and check required fields
        local skills_output
        skills_output=$(python3 << 'EOF' 2>/dev/null
import yaml
import sys

try:
    with open('/Users/shaansisodia/.blackbox5/5-project-memory/blackbox5/operations/skill-registry.yaml', 'r') as f:
        data = yaml.safe_load(f)

    skills = data.get('skills', {})
    errors = []

    for skill_id, skill_data in skills.items():
        # Check required fields
        required_fields = ['name', 'description', 'category']
        for field in required_fields:
            if field not in skill_data:
                errors.append(f"{skill_id}: missing required field '{field}'")

        # Check metrics section
        if 'metrics' not in skill_data:
            errors.append(f"{skill_id}: missing 'metrics' section")

        # Check usage section
        if 'usage' not in skill_data:
            errors.append(f"{skill_id}: missing 'usage' section")

        # Check selection section
        if 'selection' not in skill_data:
            errors.append(f"{skill_id}: missing 'selection' section")

    if errors:
        for error in errors:
            print(f"ERROR:{error}")
        sys.exit(1)
    else:
        print("OK:All skills have required fields")
        sys.exit(0)
except Exception as e:
    print(f"ERROR:Validation failed: {e}")
    sys.exit(1)
EOF
)

        if echo "$skills_output" | grep -q "^ERROR:"; then
            echo "$skills_output" | grep "^ERROR:" | sed 's/^ERROR://' | while read -r error; do
                log_error "$error"
                ((local_errors++)) || true
            done
        else
            log_success "All skill entries have required fields"
        fi
    fi

    echo ""
    if [ "$local_errors" -eq 0 ]; then
        log_success "Skills validation passed"
        return 0
    else
        log_error "Skills validation failed with $local_errors error(s)"
        return 1
    fi
}

# =============================================================================
# VALIDATE ALL
# =============================================================================

validate_all() {
    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  Running All Validations"
    echo "═══════════════════════════════════════════════════════════════"

    local failed=0

    # Run each validation
    validate_docs "$1" || ((failed++)) || true
    validate_task "$2" || ((failed++)) || true
    validate_ssot || ((failed++)) || true
    validate_skills || ((failed++)) || true

    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  Validation Summary"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""

    if [ "$failed" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
        log_success "All validations passed!"
        return 0
    else
        log_error "Validation completed with failures"
        return 1
    fi
}

# =============================================================================
# MAIN
# =============================================================================

COMMAND="${1:-}"
ARG="${2:-}"

# Show help if no command
if [ -z "$COMMAND" ]; then
    echo "bb5 validate - Validation CLI for BlackBox5"
    echo ""
    echo "Usage:"
    echo "  bb5 validate docs [RUN-DIR]      Validate run documentation"
    echo "  bb5 validate task [TASK-ID]      Validate task completeness"
    echo "  bb5 validate ssot                Validate STATE.yaml consistency"
    echo "  bb5 validate skills              Validate skill usage logging"
    echo "  bb5 validate all                 Run all validations"
    echo ""
    echo "Exit Codes:"
    echo "  0 = All validations passed"
    echo "  1 = One or more validations failed"
    exit 0
fi

# Route to appropriate validation
case "$COMMAND" in
    docs)
        validate_docs "$ARG"
        ;;
    task)
        validate_task "$ARG"
        ;;
    ssot)
        validate_ssot
        ;;
    skills)
        validate_skills
        ;;
    all)
        validate_all "$ARG"
        ;;
    *)
        echo "Unknown command: $COMMAND"
        echo "Usage: bb5 validate {docs|task|ssot|skills|all}"
        exit 1
        ;;
esac

# Exit with appropriate code
if [ "$ERRORS" -gt 0 ]; then
    exit 1
else
    exit 0
fi
