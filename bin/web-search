#!/usr/bin/env python3
"""
Web Search CLI for Blackbox5
Searches the web using a SearXNG instance

Usage:
    web-search "query" [--json] [--count N]
    web-search --setup

Environment:
    WEB_SEARCH_URL - URL of your SearXNG instance

Config:
    ~/.config/blackbox5/web-search.conf
"""

import argparse
import json
import os
import sys
import urllib.parse
import urllib.request
from pathlib import Path


def get_config_path():
    """Get the config file path."""
    home = Path.home()
    return home / ".config" / "blackbox5" / "web-search.conf"


def load_config():
    """Load configuration from file or environment."""
    # First check environment
    url = os.environ.get("WEB_SEARCH_URL")
    if url:
        return {"url": url}

    # Then check config file
    config_path = get_config_path()
    if config_path.exists():
        config = {}
        with open(config_path) as f:
            for line in f:
                if "=" in line and not line.startswith("#"):
                    key, value = line.strip().split("=", 1)
                    config[key] = value
        if "WEB_SEARCH_URL" in config:
            return {"url": config["WEB_SEARCH_URL"]}

    return None


def save_config(url):
    """Save configuration to file."""
    config_path = get_config_path()
    config_path.parent.mkdir(parents=True, exist_ok=True)
    with open(config_path, "w") as f:
        f.write(f"# Blackbox5 Web Search Configuration\n")
        f.write(f"# Set your SearXNG instance URL here\n")
        f.write(f"WEB_SEARCH_URL={url}\n")
    print(f"Configuration saved to {config_path}")


def search(query, base_url, count=5, format_json=False):
    """
    Search using SearXNG API.

    Args:
        query: Search query string
        base_url: SearXNG instance URL
        count: Number of results to return
        format_json: Return JSON instead of formatted text

    Returns:
        Search results as string or dict
    """
    # Build search URL
    params = {
        "q": query,
        "format": "json",
        "language": "en",
        "safesearch": "1",
        "categories": "general"
    }

    search_url = f"{base_url}/search?{urllib.parse.urlencode(params)}"

    try:
        req = urllib.request.Request(
            search_url,
            headers={
                "User-Agent": "Blackbox5-WebSearch/1.0",
                "Accept": "application/json"
            }
        )

        with urllib.request.urlopen(req, timeout=30) as response:
            data = json.loads(response.read().decode("utf-8"))

        # Parse results
        results = []
        for result in data.get("results", [])[:count]:
            results.append({
                "title": result.get("title", "No title"),
                "url": result.get("url", ""),
                "snippet": result.get("content", ""),
                "engine": result.get("engine", "unknown")
            })

        if format_json:
            return json.dumps({
                "query": query,
                "count": len(results),
                "results": results
            }, indent=2)
        else:
            # Format as human-readable text
            output = [f"Search results for: {query}\n"]
            for i, r in enumerate(results, 1):
                output.append(f"{i}. {r['title']}")
                output.append(f"   URL: {r['url']}")
                output.append(f"   {r['snippet'][:200]}..." if len(r['snippet']) > 200 else f"   {r['snippet']}")
                output.append("")
            return "\n".join(output)

    except urllib.error.HTTPError as e:
        return f"Error: HTTP {e.code} - {e.reason}"
    except urllib.error.URLError as e:
        return f"Error: Failed to connect to search server. {e.reason}"
    except json.JSONDecodeError:
        return "Error: Invalid response from search server"
    except Exception as e:
        return f"Error: {str(e)}"


def setup_wizard():
    """Interactive setup wizard."""
    print("=" * 60)
    print("Blackbox5 Web Search Setup")
    print("=" * 60)
    print()
    print("This tool requires a SearXNG instance.")
    print()
    print("Options:")
    print("1. Deploy on Render (free tier): https://render.com")
    print("2. Deploy on Railway: https://railway.app")
    print("3. Self-host with Docker")
    print()
    print("See the skill documentation for detailed setup instructions:")
    print("  2-engine/.autonomous/skills/web-search.md")
    print()

    url = input("Enter your SearXNG URL (e.g., https://your-search.onrender.com): ").strip()

    if not url:
        print("No URL provided. Exiting.")
        return 1

    # Remove trailing slash
    url = url.rstrip("/")

    # Test the connection
    print(f"\nTesting connection to {url}...")
    result = search("test", url, count=1, format_json=True)

    try:
        json.loads(result)
        print("✓ Connection successful!")
        save_config(url)
        print("\nSetup complete. You can now use:")
        print('  web-search "your query"')
        return 0
    except:
        print("✗ Connection failed. Please check your URL and try again.")
        print(f"Response: {result}")
        return 1


def main():
    parser = argparse.ArgumentParser(
        description="Search the web using SearXNG",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  web-search "React 19 features"
  web-search "best Python frameworks" --count 10
  web-search "MCP servers" --json
  web-search --setup
        """
    )

    parser.add_argument("query", nargs="?", help="Search query")
    parser.add_argument("--json", action="store_true", help="Output JSON format")
    parser.add_argument("--count", type=int, default=5, help="Number of results (default: 5)")
    parser.add_argument("--setup", action="store_true", help="Run setup wizard")

    args = parser.parse_args()

    # Setup mode
    if args.setup:
        return setup_wizard()

    # Check for query
    if not args.query:
        parser.print_help()
        return 1

    # Load configuration
    config = load_config()
    if not config:
        print("Error: No search URL configured.")
        print()
        print("Run setup:")
        print("  web-search --setup")
        print()
        print("Or set environment variable:")
        print('  export WEB_SEARCH_URL="https://your-search.onrender.com"')
        return 1

    # Perform search
    result = search(args.query, config["url"], args.count, args.json)
    print(result)
    return 0


if __name__ == "__main__":
    sys.exit(main())
