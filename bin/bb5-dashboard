#!/usr/bin/env python3
"""BB5 Dashboard - Live terminal UI for system health monitoring.

Usage:
    bb5-dashboard [options]

Options:
    -r, --refresh SECONDS   Refresh interval (default: 5)
    -h, --help              Show this help message

Interactive Controls:
    q / Ctrl+C              Quit
    r                       Force refresh
    1/2/3                   Switch view (overview/queue/agents)
"""

import argparse
import sys
import time
from datetime import datetime
from pathlib import Path

# Add lib to path
sys.path.insert(0, str(Path(__file__).parent / "lib"))

try:
    from rich.console import Console
    from rich.layout import Layout
    from rich.panel import Panel
    from rich.table import Table
    from rich.text import Text
    from rich.live import Live
    from rich import box
except ImportError:
    print("Error: rich library required. Install with: pip install rich")
    sys.exit(1)

from health_monitor import (
    collect_queue,
    collect_heartbeat,
    collect_events,
    collect_metrics,
    calculate_health_score,
    calculate_queue_health,
    calculate_agent_health,
    calculate_throughput,
    calculate_commit_compliance,
    detect_stuck_tasks,
    get_health_emoji,
    format_duration,
)


console = Console()


def get_health_color(score: int) -> str:
    """Get color for health score."""
    if score >= 90:
        return "green"
    elif score >= 75:
        return "yellow"
    elif score >= 60:
        return "orange3"
    else:
        return "red"


def create_health_panel(data: dict) -> Panel:
    """Create main health score panel."""
    score = data["health_score"]
    status = data["status"].upper()
    color = get_health_color(score)
    emoji = get_health_emoji(score)

    content = Text()
    content.append(f"{emoji} ", style="bold")
    content.append(f"{score}/100", style=f"bold {color}")
    content.append(f"\nStatus: {status}", style=color)
    content.append(f"\n\nLast Updated:\n{data['timestamp'][:19]}", style="dim")

    return Panel(
        content,
        title="[bold]BB5 Health[/bold]",
        border_style=color,
        box=box.ROUNDED,
    )


def create_queue_panel(data: dict) -> Panel:
    """Create queue status panel."""
    q = data["queue"]
    color = get_health_color(q["health_score"])

    table = Table(show_header=False, box=None, padding=(0, 1))
    table.add_column("label", style="dim")
    table.add_column("value", style="bold")

    table.add_row("Pending", str(q["pending"]))
    table.add_row("In Progress", str(q["in_progress"]))
    table.add_row("Completed", str(q["completed"]))
    table.add_row("Blocked", str(q["blocked"]))
    table.add_row("Total", str(q["total"]))
    table.add_row("Health", f"{q['health_score']:.0f}/100")

    return Panel(
        table,
        title="[bold]Queue Status[/bold]",
        border_style=color,
        box=box.ROUNDED,
    )


def create_agents_panel(data: dict) -> Panel:
    """Create agent status panel."""
    a = data["agents"]
    color = get_health_color(a["health_score"])

    table = Table(show_header=False, box=None, padding=(0, 1))
    table.add_column("label", style="dim")
    table.add_column("value", style="bold")

    table.add_row("Online", f"[green]{a['online']}[/green]")
    table.add_row("Stale", f"[yellow]{a['stale']}[/yellow]" if a["stale"] else "0")
    table.add_row("Offline", f"[red]{a['offline']}[/red]" if a["offline"] else "0")
    table.add_row("Total", str(a["total"]))
    table.add_row("Health", f"{a['health_score']:.0f}/100")

    return Panel(
        table,
        title="[bold]Agent Status[/bold]",
        border_style=color,
        box=box.ROUNDED,
    )


def create_throughput_panel(data: dict) -> Panel:
    """Create throughput panel."""
    t = data["throughput"]

    table = Table(show_header=False, box=None, padding=(0, 1))
    table.add_column("label", style="dim")
    table.add_column("value", style="bold")

    table.add_row("Tasks/Day", str(t["tasks_per_day"]))
    table.add_row("Target", str(t["target"]))

    completion = (t["tasks_per_day"] / t["target"]) * 100 if t["target"] > 0 else 0
    table.add_row("Completion", f"{completion:.0f}%")

    return Panel(
        table,
        title="[bold]Throughput[/bold]",
        border_style="blue",
        box=box.ROUNDED,
    )


def create_compliance_panel(data: dict) -> Panel:
    """Create commit compliance panel."""
    c = data.get("compliance", {})

    if not c:
        return Panel(
            "[dim]No compliance data[/dim]",
            title="[bold]Commit Compliance[/bold]",
            box=box.ROUNDED,
        )

    compliance_rate = c.get('compliance_rate', 0)
    threshold = c.get('threshold', 75)
    meets = c.get('meets_threshold', False)

    color = "green" if meets else "red"
    with_commits = c.get('with_commits', 0)
    total = c.get('total_tasks', 0)

    table = Table(show_header=False, box=None, padding=(0, 1))
    table.add_column("label", style="dim")
    table.add_column("value", style="bold")

    table.add_row("Rate", f"[{color}]{compliance_rate:.1f}%[/{color}]")
    table.add_row("Threshold", f"{threshold}%")
    table.add_row("Tasks", f"{with_commits}/{total}")

    # Show category breakdown if available
    by_cat = c.get('by_category', {})
    if by_cat:
        table.add_row("", "")
        table.add_row("[dim]By Category:[/dim]", "")
        for cat, stats in sorted(by_cat.items())[:3]:  # Top 3 categories
            rate = stats.get('rate', 0)
            cat_color = "green" if rate >= threshold else "yellow"
            table.add_row(f"  {cat}", f"[{cat_color}]{rate:.0f}%[/{cat_color}]")

    return Panel(
        table,
        title="[bold]Commit Compliance[/bold]",
        border_style=color,
        box=box.ROUNDED,
    )


def create_stuck_tasks_panel(data: dict) -> Panel:
    """Create stuck tasks panel."""
    stuck = data.get("stuck_tasks", [])

    if not stuck:
        return Panel(
            "[green]No stuck tasks detected[/green]",
            title="[bold]Stuck Tasks[/bold]",
            border_style="green",
            box=box.ROUNDED,
        )

    table = Table(show_header=True, box=None, padding=(0, 1))
    table.add_column("Task ID", style="dim", no_wrap=True)
    table.add_column("Title", max_width=30)
    table.add_column("Duration", style="yellow")

    for st in stuck[:5]:
        table.add_row(
            st["id"],
            st["title"][:30],
            st["duration"],
        )

    if len(stuck) > 5:
        table.add_row("", f"... and {len(stuck) - 5} more", "")

    return Panel(
        table,
        title=f"[bold]Stuck Tasks ({len(stuck)})[/bold]",
        border_style="red",
        box=box.ROUNDED,
    )


def create_agent_details_panel() -> Panel:
    """Create detailed agent panel."""
    agents = collect_heartbeat()

    if not agents:
        return Panel(
            "[dim]No agents registered[/dim]",
            title="[bold]Agent Details[/bold]",
            box=box.ROUNDED,
        )

    table = Table(show_header=True, box=None)
    table.add_column("Agent", style="bold")
    table.add_column("Status")
    table.add_column("Last Seen")
    table.add_column("Current Task")
    table.add_column("Loop")

    for agent in agents:
        status_color = "green" if agent.is_online() else "yellow" if agent.is_stale() else "red"
        status_text = f"[{status_color}]{agent.get_status().value}[/{status_color}]"

        table.add_row(
            agent.name,
            status_text,
            format_duration(agent.seconds_since_seen()),
            agent.current_task or "-",
            str(agent.loop_number),
        )

    return Panel(
        table,
        title="[bold]Agent Details[/bold]",
        box=box.ROUNDED,
    )


def create_queue_details_panel() -> Panel:
    """Create detailed queue panel."""
    tasks = collect_queue()

    if not tasks:
        return Panel(
            "[dim]No tasks in queue[/dim]",
            title="[bold]Task Queue[/bold]",
            box=box.ROUNDED,
        )

    table = Table(show_header=True, box=None)
    table.add_column("ID", style="dim", no_wrap=True)
    table.add_column("Title", max_width=35)
    table.add_column("Status")
    table.add_column("Priority")
    table.add_column("Est.")

    # Show most recent tasks
    for task in tasks[:10]:
        status_color = {
            "pending": "dim",
            "in_progress": "blue",
            "completed": "green",
            "blocked": "red",
        }.get(task.status.value, "white")

        table.add_row(
            task.id,
            task.title[:35],
            f"[{status_color}]{task.status.value}[/{status_color}]",
            task.priority,
            f"{task.estimated_minutes}m",
        )

    return Panel(
        table,
        title=f"[bold]Task Queue ({len(tasks)} total)[/bold]",
        box=box.ROUNDED,
    )


def create_dashboard_layout(view: str = "overview") -> Layout:
    """Create the main dashboard layout."""
    # Collect data
    tasks = collect_queue()
    agents = collect_heartbeat()
    events = collect_events()
    metrics = collect_metrics()

    score, status, details = calculate_health_score(tasks, agents, events, metrics)
    queue_score, queue_status = calculate_queue_health(tasks)
    agent_score, agent_status = calculate_agent_health(agents)
    throughput_val = calculate_throughput(tasks)
    stuck = detect_stuck_tasks(tasks, events)
    compliance = calculate_commit_compliance(days=30, threshold=75.0)

    pending = sum(1 for t in tasks if t.status.value == "pending")
    in_progress = sum(1 for t in tasks if t.status.value == "in_progress")
    completed = sum(1 for t in tasks if t.status.value == "completed")
    blocked = sum(1 for t in tasks if t.status.value == "blocked")

    online = sum(1 for a in agents if a.is_online())
    stale = sum(1 for a in agents if a.is_stale())
    offline = len(agents) - online - stale

    data = {
        "timestamp": datetime.now().isoformat(),
        "health_score": score,
        "status": status.value,
        "queue": {
            "pending": pending,
            "in_progress": in_progress,
            "completed": completed,
            "blocked": blocked,
            "total": len(tasks),
            "health_score": queue_score,
            "health_status": queue_status,
        },
        "agents": {
            "online": online,
            "stale": stale,
            "offline": offline,
            "total": len(agents),
            "health_score": agent_score,
            "health_status": agent_status,
        },
        "throughput": {
            "tasks_per_day": round(throughput_val, 2),
            "target": 5,
        },
        "compliance": compliance,
        "stuck_tasks": [
            {
                "id": st.task.id,
                "title": st.task.title,
                "reason": st.reason,
                "duration": st.stuck_duration,
            }
            for st in stuck
        ],
    }

    # Create layout
    layout = Layout()

    if view == "overview":
        layout.split_column(
            Layout(name="header", size=3),
            Layout(name="main"),
            Layout(name="footer", size=3),
        )
        layout["main"].split_row(
            Layout(name="left"),
            Layout(name="right"),
        )
        layout["left"].split_column(
            Layout(name="health"),
            Layout(name="queue"),
            Layout(name="compliance"),
        )
        layout["right"].split_column(
            Layout(name="agents"),
            Layout(name="throughput"),
        )

        # Add panels
        layout["header"].update(Panel(
            "[bold]BB5 Health Dashboard[/bold] | [dim]Press 'q' to quit, 'r' to refresh, '1/2/3' for views[/dim]",
            box=box.SIMPLE,
        ))
        layout["health"].update(create_health_panel(data))
        layout["queue"].update(create_queue_panel(data))
        layout["compliance"].update(create_compliance_panel(data))
        layout["agents"].update(create_agents_panel(data))
        layout["throughput"].update(create_throughput_panel(data))
        layout["footer"].update(create_stuck_tasks_panel(data))

    elif view == "queue":
        layout.split_column(
            Layout(name="header", size=3),
            Layout(name="main"),
        )
        layout["header"].update(Panel(
            "[bold]BB5 Health Dashboard - Queue View[/bold] | [dim]Press 'q' to quit, '1' overview, '3' agents[/dim]",
            box=box.SIMPLE,
        ))
        layout["main"].update(create_queue_details_panel())

    elif view == "agents":
        layout.split_column(
            Layout(name="header", size=3),
            Layout(name="main"),
        )
        layout["header"].update(Panel(
            "[bold]BB5 Health Dashboard - Agent View[/bold] | [dim]Press 'q' to quit, '1' overview, '2' queue[/dim]",
            box=box.SIMPLE,
        ))
        layout["main"].update(create_agent_details_panel())

    return layout


def run_dashboard(refresh_interval: int = 5):
    """Run the live dashboard."""
    current_view = "overview"

    with Live(create_dashboard_layout(current_view), refresh_per_second=4, screen=True) as live:
        try:
            while True:
                time.sleep(refresh_interval)
                live.update(create_dashboard_layout(current_view))
        except KeyboardInterrupt:
            pass


def main():
    parser = argparse.ArgumentParser(
        description="BB5 Dashboard - Live terminal UI",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Interactive Controls:
    q / Ctrl+C              Quit
    r                       Force refresh
    1/2/3                   Switch view (overview/queue/agents)
        """
    )
    parser.add_argument(
        "-r", "--refresh",
        type=int,
        default=5,
        help="Refresh interval in seconds (default: 5)"
    )

    args = parser.parse_args()

    console.clear()
    console.print("[bold green]Starting BB5 Dashboard...[/bold green]")
    console.print(f"[dim]Refresh interval: {args.refresh}s[/dim]")
    console.print("[dim]Press Ctrl+C to exit[/dim]\n")

    time.sleep(1)

    try:
        run_dashboard(args.refresh)
    except Exception as e:
        console.print(f"[red]Error: {e}[/red]")
        sys.exit(1)

    console.clear()
    console.print("[dim]Dashboard closed[/dim]")


if __name__ == "__main__":
    main()
