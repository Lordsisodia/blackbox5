#!/bin/bash
# bb5-queue - Task queue management commands
# Usage: bb5 queue list | bb5 queue next | bb5 queue ready | bb5 queue blocked | bb5 queue claimed

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BLACKBOX5_DIR="$PROJECT_ROOT/5-project-memory/blackbox5"
QUEUE_FILE="$BLACKBOX5_DIR/.autonomous/agents/communications/queue.yaml"

COMMAND="${1:-list}"

# Colors
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    RED='\033[0;31m'
    MAGENTA='\033[0;35m'
    NC='\033[0m'
else
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    RED=''
    MAGENTA=''
    NC=''
fi

# Check if queue file exists
if [ ! -f "$QUEUE_FILE" ]; then
    echo "Queue file not found: $QUEUE_FILE"
    exit 1
fi

# Parse queue.yaml and extract task data using awk
# Output format: id|title|priority|status|priority_score|blockedBy|claimedBy
tasks=$(awk '
BEGIN { in_tasks = 0; task_idx = -1 }
/^tasks:/ { in_tasks = 1; next }
/^queue_metadata:/ { in_tasks = 0; next }
in_tasks && /^  - id:/ {
    task_idx++
    gsub(/"/, "", $3)
    ids[task_idx] = $3
    next
}
in_tasks && /title:/ {
    gsub(/.*title: "?/, "")
    gsub(/"?$/, "")
    titles[task_idx] = $0
    next
}
in_tasks && /priority:/ && !/priority_score:/ {
    gsub(/.*priority: "?/, "")
    gsub(/"?$/, "")
    priorities[task_idx] = $0
    next
}
in_tasks && /status:/ {
    gsub(/.*status: "?/, "")
    gsub(/"?$/, "")
    statuses[task_idx] = $0
    next
}
in_tasks && /priority_score:/ {
    gsub(/.*priority_score: /, "")
    scores[task_idx] = $0
    next
}
in_tasks && /blockedBy:/ {
    gsub(/.*blockedBy: /, "")
    blocked[task_idx] = $0
    next
}
in_tasks && /claimedBy:/ {
    gsub(/.*claimedBy: /, "")
    claimed[task_idx] = $0
    next
}
END {
    for (i = 0; i <= task_idx; i++) {
        print ids[i] "|" titles[i] "|" priorities[i] "|" statuses[i] "|" scores[i] "|" blocked[i] "|" claimed[i]
    }
}
' "$QUEUE_FILE")

# Priority value for sorting (higher = more important)
get_priority_value() {
    case "$1" in
        CRITICAL) echo 4 ;;
        HIGH) echo 3 ;;
        MEDIUM) echo 2 ;;
        LOW) echo 1 ;;
        *) echo 0 ;;
    esac
}

# Color code for priority
get_priority_color() {
    case "$1" in
        CRITICAL) echo "$RED" ;;
        HIGH) echo "$YELLOW" ;;
        MEDIUM) echo "$CYAN" ;;
        LOW) echo "$NC" ;;
        *) echo "$NC" ;;
    esac
}

# Color code for status
get_status_color() {
    case "$1" in
        completed) echo "$GREEN" ;;
        in_progress) echo "$YELLOW" ;;
        pending) echo "$BLUE" ;;
        blocked) echo "$RED" ;;
        *) echo "$NC" ;;
    esac
}

# Format blocked by for display
format_blocked() {
    local blocked="$1"
    if [ -z "$blocked" ] || [ "$blocked" = "[]" ]; then
        echo "-"
    else
        # Remove brackets and quotes, keep task IDs
        echo "$blocked" | sed 's/\[//g; s/\]//g; s/"//g; s/,/, /g'
    fi
}

# Format claimed by for display
format_claimed() {
    local claimed="$1"
    if [ -z "$claimed" ] || [ "$claimed" = "[]" ] || [ "$claimed" = "null" ]; then
        echo "-"
    else
        echo "$claimed" | sed 's/"//g'
    fi
}

# Check if task is ready (no blockedBy dependencies)
is_ready() {
    local blocked="$1"
    [ -z "$blocked" ] || [ "$blocked" = "[]" ]
}

# Check if task is claimed
is_claimed() {
    local claimed="$1"
    [ -n "$claimed" ] && [ "$claimed" != "[]" ] && [ "$claimed" != "null" ]
}

# Display header
display_header() {
    echo "═══════════════════════════════════════════════════════════════════════════════════"
    printf "  %-12s %-40s %-10s %-12s %s\n" "Task ID" "Title" "Priority" "Status" "Score"
    echo "═══════════════════════════════════════════════════════════════════════════════════"
}

# Display task row
display_task() {
    local id="$1"
    local title="$2"
    local priority="$3"
    local status="$4"
    local score="$5"
    local blocked="$6"
    local claimed="$7"

    # Truncate title if too long
    if [ ${#title} -gt 38 ]; then
        title="${title:0:35}..."
    fi

    local priority_color=$(get_priority_color "$priority")
    local status_color=$(get_status_color "$status")

    printf "  ${CYAN}%-12s${NC} %-40s ${priority_color}%-10s${NC} ${status_color}%-12s${NC} %s\n" \
        "$id" "$title" "$priority" "$status" "$score"

    # Show blocked by if present
    local blocked_formatted=$(format_blocked "$blocked")
    if [ "$blocked_formatted" != "-" ]; then
        printf "    ${RED}Blocked by:${NC} %s\n" "$blocked_formatted"
    fi

    # Show claimed by if present
    local claimed_formatted=$(format_claimed "$claimed")
    if [ "$claimed_formatted" != "-" ]; then
        printf "    ${MAGENTA}Claimed by:${NC} %s\n" "$claimed_formatted"
    fi
}

# Display footer
display_footer() {
    echo "═══════════════════════════════════════════════════════════════════════════════════"
}

case "$COMMAND" in
    list)
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo "  Task Queue (sorted by priority score)"
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo ""

        # Sort tasks by priority_score (descending), then by priority value
        sorted_tasks=$(echo "$tasks" | sort -t'|' -k5,5nr -k3,3r)

        display_header

        echo "$sorted_tasks" | while IFS='|' read -r id title priority status score blocked claimed; do
            display_task "$id" "$title" "$priority" "$status" "$score" "$blocked" "$claimed"
        done

        display_footer

        # Show summary
        total=$(echo "$tasks" | wc -l)
        pending=$(echo "$tasks" | grep '|pending|' | wc -l)
        in_progress=$(echo "$tasks" | grep '|in_progress|' | wc -l)
        completed=$(echo "$tasks" | grep '|completed|' | wc -l)

        echo ""
        echo "Summary: $total total | ${BLUE}$pending pending${NC} | ${YELLOW}$in_progress in progress${NC} | ${GREEN}$completed completed${NC}"
        ;;

    next)
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo "  Next Ready Task (highest priority)"
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo ""

        # Find ready tasks (pending with no blockedBy), sort by priority_score
        next_task=$(echo "$tasks" | grep '|pending|' | while IFS='|' read -r id title priority status score blocked claimed; do
            if is_ready "$blocked" && ! is_claimed "$claimed"; then
                echo "$score|$id|$title|$priority|$status|$blocked|$claimed"
            fi
        done | sort -t'|' -k1,1nr | head -1)

        if [ -z "$next_task" ]; then
            echo "No ready tasks found."
            echo ""
            echo "All pending tasks are either blocked or claimed."
            echo "Run 'bb5 queue blocked' to see blocked tasks."
            echo "Run 'bb5 queue claimed' to see claimed tasks."
        else
            display_header
            IFS='|' read -r score id title priority status blocked claimed <<< "$next_task"
            display_task "$id" "$title" "$priority" "$status" "$score" "$blocked" "$claimed"
            display_footer
            echo ""
            echo "To claim this task: bb5 task:claim $id"
        fi
        ;;

    ready)
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo "  Ready Tasks (no dependencies, pending)"
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo ""

        # Find ready tasks
        ready_tasks=$(echo "$tasks" | grep '|pending|' | while IFS='|' read -r id title priority status score blocked claimed; do
            if is_ready "$blocked"; then
                echo "$score|$id|$title|$priority|$status|$blocked|$claimed"
            fi
        done | sort -t'|' -k1,1nr)

        if [ -z "$ready_tasks" ]; then
            echo "No ready tasks found."
            echo ""
            echo "All pending tasks have dependencies."
            echo "Run 'bb5 queue blocked' to see blocked tasks."
        else
            display_header

            echo "$ready_tasks" | while IFS='|' read -r score id title priority status blocked claimed; do
                display_task "$id" "$title" "$priority" "$status" "$score" "$blocked" "$claimed"
            done

            display_footer

            count=$(echo "$ready_tasks" | wc -l)
            echo ""
            echo "Total ready tasks: $count"
        fi
        ;;

    blocked)
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo "  Blocked Tasks (has dependencies)"
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo ""

        # Find blocked tasks
        blocked_tasks=$(echo "$tasks" | while IFS='|' read -r id title priority status score blocked claimed; do
            if ! is_ready "$blocked"; then
                echo "$score|$id|$title|$priority|$status|$blocked|$claimed"
            fi
        done | sort -t'|' -k1,1nr)

        if [ -z "$blocked_tasks" ]; then
            echo "No blocked tasks found."
            echo ""
            echo "All tasks are ready to execute!"
        else
            display_header

            echo "$blocked_tasks" | while IFS='|' read -r score id title priority status blocked claimed; do
                display_task "$id" "$title" "$priority" "$status" "$score" "$blocked" "$claimed"
            done

            display_footer

            count=$(echo "$blocked_tasks" | wc -l)
            echo ""
            echo "Total blocked tasks: $count"
        fi
        ;;

    claimed)
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo "  Claimed Tasks"
        echo "═══════════════════════════════════════════════════════════════════════════════════"
        echo ""

        # Find claimed tasks
        claimed_tasks=$(echo "$tasks" | while IFS='|' read -r id title priority status score blocked claimed; do
            if is_claimed "$claimed"; then
                echo "$score|$id|$title|$priority|$status|$blocked|$claimed"
            fi
        done | sort -t'|' -k1,1nr)

        if [ -z "$claimed_tasks" ]; then
            echo "No claimed tasks found."
            echo ""
            echo "All tasks are unclaimed and available."
        else
            display_header

            echo "$claimed_tasks" | while IFS='|' read -r score id title priority status blocked claimed; do
                display_task "$id" "$title" "$priority" "$status" "$score" "$blocked" "$claimed"
            done

            display_footer

            count=$(echo "$claimed_tasks" | wc -l)
            echo ""
            echo "Total claimed tasks: $count"
        fi
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo ""
        echo "Usage: bb5 queue <command>"
        echo ""
        echo "Commands:"
        echo "  list      Show all tasks in priority order"
        echo "  next      Show highest priority ready task"
        echo "  ready     Show tasks ready to execute (no dependencies)"
        echo "  blocked   Show blocked tasks with dependencies"
        echo "  claimed   Show claimed tasks"
        exit 1
        ;;
esac
