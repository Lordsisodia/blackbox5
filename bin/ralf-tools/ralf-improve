#!/bin/bash
# RALF Improvement Loop
# Activates RALF in improvement mode to autonomously find and implement improvements
#
# Usage: ralf-improve [--continuous] [--interval MINUTES]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BLACKBOX5_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
ENGINE_DIR="$BLACKBOX5_DIR/2-engine"
PROJECT_DIR="${RALF_PROJECT_DIR:-$BLACKBOX5_DIR/5-project-memory/blackbox5}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[$(date '+%H:%M:%S')]${NC} $1"
}

log_phase() {
    echo -e "${CYAN}[PHASE]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Show banner
echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║              RALF Improvement Loop                          ║"
echo "║              Self-Improving Agent System                    ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""

# Parse arguments
CONTINUOUS=false
INTERVAL=300  # 5 minutes default

while [[ $# -gt 0 ]]; do
    case $1 in
        --continuous)
            CONTINUOUS=true
            shift
            ;;
        --interval)
            INTERVAL="$2"
            shift 2
            ;;
        --help)
            echo "Usage: ralf-improve [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --continuous       Run continuously"
            echo "  --interval MIN     Interval between runs (default: 300s)"
            echo "  --help             Show this help"
            echo ""
            exit 0
            ;;
        *)
            log_warning "Unknown option: $1"
            shift
            ;;
    esac
done

# Check prerequisites
if ! command -v claude &> /dev/null; then
    log "Error: claude command not found"
    exit 1
fi

# Create improvement directory
IMPROVE_DIR="$PROJECT_DIR/.autonomous/improvements"
mkdir -p "$IMPROVE_DIR"
mkdir -p "$IMPROVE_DIR/scout-reports"
mkdir -p "$IMPROVE_DIR/plans"
mkdir -p "$IMPROVE_DIR/validations"

# Build combined prompt
PROMPT_FILE="$ENGINE_DIR/.autonomous/prompts/ralf.md"
IMPROVE_PROMPT="$ENGINE_DIR/.autonomous/prompts/ralf-improvement-loop.md"

if [[ ! -f "$PROMPT_FILE" ]]; then
    log "Error: Base RALF prompt not found: $PROMPT_FILE"
    exit 1
fi

if [[ ! -f "$IMPROVE_PROMPT" ]]; then
    log "Error: Improvement prompt not found: $IMPROVE_PROMPT"
    exit 1
fi

# Function to run single improvement loop
run_improvement_loop() {
    local TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    local SESSION_LOG="$IMPROVE_DIR/session-$TIMESTAMP.log"

    log_phase "Starting Improvement Loop"
    log "Project: $PROJECT_DIR"
    log "Session: $SESSION_LOG"
    log "Mode: IMPROVE"

    # Export environment
    export RALF_PROJECT_DIR="$PROJECT_DIR"
    export RALF_ENGINE_DIR="$ENGINE_DIR"
    export RALF_BLACKBOX5_DIR="$BLACKBOX5_DIR"
    export RALF_IMPROVE_MODE="true"
    export RALF_RUN_DIR="$IMPROVE_DIR/run-$TIMESTAMP"

    # Create run directory
    mkdir -p "$RALF_RUN_DIR"
    cat > "$RALF_RUN_DIR/THOUGHTS.md" << 'EOF'
# THOUGHTS - Improvement Loop

<!-- RALF_TEMPLATE: UNFILLED -->

## Improvement Analysis

FILL_ME

EOF

    cat > "$RALF_RUN_DIR/RESULTS.md" << 'EOF'
# RESULTS - Improvement Loop

<!-- RALF_TEMPLATE: UNFILLED -->

## Improvements Found

FILL_ME

## Improvements Implemented

FILL_ME

## Validation Results

FILL_ME

EOF

    cat > "$RALF_RUN_DIR/DECISIONS.md" << 'EOF'
# DECISIONS - Improvement Loop

<!-- RALF_TEMPLATE: UNFILLED -->

## Prioritization Decisions

FILL_ME

## Implementation Decisions

FILL_ME

EOF

    cat > "$RALF_RUN_DIR/LEARNINGS.md" << 'EOF'
# LEARNINGS - Improvement Loop

<!-- RALF_TEMPLATE: UNFILLED -->

## Patterns Discovered

FILL_ME

## What Worked Well

FILL_ME

## What to Improve Next Time

FILL_ME

EOF

    # Combine prompts and execute
    log "Executing RALF with improvement mode..."
    echo ""
    echo -e "${YELLOW}--- RALF Improvement Loop Start ---${NC}"
    echo ""

    # Combine base RALF + improvement prompt
    {
        cat "$PROMPT_FILE"
        echo ""
        echo "---"
        echo ""
        echo "# IMPROVEMENT MODE ACTIVATED"
        echo ""
        cat "$IMPROVE_PROMPT"
    } | claude -p --dangerously-skip-permissions 2>&1 | tee -a "$SESSION_LOG"

    local EXIT_CODE=${PIPESTATUS[0]}

    echo ""
    echo -e "${YELLOW}--- RALF Improvement Loop End ---${NC}"
    echo ""

    # Check results
    if grep -q "<promise>IMPROVEMENTS_COMPLETE</promise>" "$SESSION_LOG" 2>/dev/null; then
        log_success "Improvements completed successfully"
        return 0
    elif grep -q "<promise>NO_IMPROVEMENTS_NEEDED</promise>" "$SESSION_LOG" 2>/dev/null; then
        log "No improvements needed at this time"
        return 0
    elif grep -q "Status: BLOCKED" "$SESSION_LOG" 2>/dev/null; then
        log_warning "Improvement loop blocked"
        return 1
    else
        log_warning "Improvement loop completed with unknown status"
        return 0
    fi
}

# Main loop
if [[ "$CONTINUOUS" == "true" ]]; then
    log "Continuous mode enabled (interval: ${INTERVAL}s)"
    log "Press Ctrl+C to stop"
    echo ""

    trap 'log "Stopping improvement loop"; exit 0' INT TERM

    while true; do
        run_improvement_loop

        log "Waiting ${INTERVAL}s before next cycle..."
        sleep "$INTERVAL"
        echo ""
    done
else
    run_improvement_loop
fi

log "Improvement loop finished"
