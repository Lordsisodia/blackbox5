#!/bin/bash
# RALF Branch Manager - Simple branch operations for autonomous agents
# Usage: ralf-branch [create|switch|status|promote] [branch-name]

set -e

BLACKBOX5_DIR="/Users/shaansisodia/.blackbox5"
CURRENT_BRANCH=$(git -C "$BLACKBOX5_DIR" branch --show-current 2>/dev/null || echo "unknown")

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

usage() {
    echo "RALF Branch Manager"
    echo ""
    echo "Usage:"
    echo "  ralf-branch create <name>     Create new RFI branch from main"
    echo "  ralf-branch switch <name>     Switch to existing branch"
    echo "  ralf-branch status            Show current branch and recent commits"
    echo "  ralf-branch promote           Merge current branch to main via PR"
    echo "  ralf-branch list              List all RALF branches"
    echo ""
    echo "Current: $CURRENT_BRANCH"
}

create_branch() {
    local name="${1:-rfi-$(date +%Y%m%d)}"
    local full_name="rfi/${name}"

    echo -e "${BLUE}Creating branch: $full_name${NC}"

    cd "$BLACKBOX5_DIR"
    git checkout main
    git pull origin main
    git checkout -b "$full_name"

    # Initialize branch marker
    mkdir -p "$BLACKBOX5_DIR/.autonomous"
    echo "created: $(date -Iseconds)" > "$BLACKBOX5_DIR/.autonomous/branch-info"
    echo "purpose: RFI autonomous run" >> "$BLACKBOX5_DIR/.autonomous/branch-info"

    git add .autonomous/branch-info
    git commit -m "rfi: initialize branch $full_name" || true

    echo -e "${GREEN}✓ Branch ready: $full_name${NC}"
    echo ""
    echo "Start RALF with: ./bin/ralf"
}

switch_branch() {
    local name="$1"
    if [ -z "$name" ]; then
        echo -e "${RED}Error: branch name required${NC}"
        usage
        exit 1
    fi

    # Allow shorthand (rfi-20260131 -> rfi/rfi-20260131)
    if [[ "$name" != rfi/* ]]; then
        name="rfi/$name"
    fi

    echo -e "${BLUE}Switching to: $name${NC}"
    cd "$BLACKBOX5_DIR"
    git checkout "$name"
    echo -e "${GREEN}✓ Now on: $name${NC}"
}

show_status() {
    echo -e "${BLUE}=== RALF Branch Status ===${NC}"
    echo ""
    echo "Current branch: $CURRENT_BRANCH"
    echo ""

    cd "$BLACKBOX5_DIR"

    echo "Recent commits:"
    git log --oneline -5 2>/dev/null || echo "  (no commits yet)"
    echo ""

    echo "RALF runs on this branch:"
    local runs_dir="$BLACKBOX5_DIR/5-project-memory/blackbox5/.autonomous/runs"
    if [ -d "$runs_dir" ]; then
        ls -1 "$runs_dir" 2>/dev/null | tail -5 | sed 's/^/  /' || echo "  (none)"
    else
        echo "  (none)"
    fi
    echo ""

    # Show success rate if we have data
    local insights="$BLACKBOX5_DIR/5-project-memory/blackbox5/knowledge/ralf-patterns/auto-insights.json"
    if [ -f "$insights" ]; then
        echo "Branch analytics:"
        python3 -c "
import json
with open('$insights') as f:
    data = json.load(f)
    print(f\"  Success rate: {data.get('success_rate', 0)}%\")
    print(f\"  Loops analyzed: {data.get('total_loops_analyzed', 0)}\")
" 2>/dev/null || echo "  (analysis pending)"
    fi
}

list_branches() {
    echo -e "${BLUE}=== RALF Branches ===${NC}"
    echo ""
    cd "$BLACKBOX5_DIR"
    git branch -a | grep rfi/ | sed 's/^/  /' || echo "  (no rfi branches found)"
}

promote_branch() {
    echo -e "${YELLOW}Promoting $CURRENT_BRANCH to main${NC}"
    echo ""

    # Check for uncommitted changes
    cd "$BLACKBOX5_DIR"
    if ! git diff --quiet HEAD 2>/dev/null; then
        echo -e "${RED}Error: Uncommitted changes on branch${NC}"
        echo "Commit first: git add -A && git commit -m '...'"
        exit 1
    fi

    echo "This will:"
    echo "  1. Push $CURRENT_BRANCH to GitHub"
    echo "  2. Create PR to merge into main"
    echo ""
    read -p "Continue? (y/N) " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git push -u origin "$CURRENT_BRANCH"
        gh pr create --title "RFI: Promote $CURRENT_BRANCH" --body "Autonomous agent run ready for review." || true
        echo -e "${GREEN}✓ PR created${NC}"
    else
        echo "Cancelled"
    fi
}

# Main
case "${1:-}" in
    create)
        create_branch "$2"
        ;;
    switch|checkout)
        switch_branch "$2"
        ;;
    status|st)
        show_status
        ;;
    list|ls)
        list_branches
        ;;
    promote|merge)
        promote_branch
        ;;
    *)
        usage
        ;;
esac
