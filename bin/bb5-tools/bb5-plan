#!/bin/bash
# bb5-plan - Plan management commands
# Usage: bb5 plan:list | bb5 plan:show [PLAN-ID]

set -e
# Source dry-run utility library
source "$(dirname "$0")/../../2-engine/helpers/legacy/dry_run.sh" 2>/dev/null || true

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BLACKBOX5_DIR="$PROJECT_ROOT/5-project-memory/blackbox5"
PLANS_DIR="$BLACKBOX5_DIR/plans/active"

COMMAND="${1:-list}"
PLAN_ID="${2:-}"

# Colors
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    NC=''
fi

case "$COMMAND" in
    list)
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Active Plans"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        if [ ! -d "$PLANS_DIR" ]; then
            echo "No plans directory found at $PLANS_DIR"
            exit 1
        fi

        # Count plans
        PLAN_COUNT=$(find "$PLANS_DIR" -maxdepth 1 -type d | grep -v "^$PLANS_DIR$" | wc -l)

        if [ "$PLAN_COUNT" -eq 0 ]; then
            echo "No active plans found."
            echo ""
            echo "Create a plan with:"
            echo "  bb5 plan:create 'Plan Name'"
        else
            for plan_dir in "$PLANS_DIR"/*/; do
                if [ -d "$plan_dir" ]; then
                    plan_id=$(basename "$plan_dir")
                    metadata_file="$plan_dir/metadata.yaml"
                    readme_file="$plan_dir/README.md"

                    plan_name="$plan_id"
                    plan_status="unknown"

                    # Try to get name from metadata.yaml
                    if [ -f "$metadata_file" ]; then
                        plan_name=$(grep "^name:" "$metadata_file" 2>/dev/null | sed 's/name: "\(.*\)"/\1/' | head -1 || echo "$plan_id")
                        plan_status=$(grep "status:" "$metadata_file" 2>/dev/null | sed 's/.*status: \(.*\)/\1/' | head -1 || echo "unknown")
                    elif [ -f "$readme_file" ]; then
                        # Try to get name from first line of README
                        plan_name=$(head -1 "$readme_file" | sed 's/^# //' | head -c 50)
                    fi

                    # Color code by status
                    status_color="$NC"
                    case "$plan_status" in
                        completed) status_color="$GREEN" ;;
                        in_progress) status_color="$YELLOW" ;;
                        blocked) status_color="\033[0;31m" ;;
                    esac

                    printf "${CYAN}%s${NC} - %s\n" "$plan_id" "$plan_name"
                    printf "  Status: ${status_color}%s${NC}\n" "$plan_status"

                    # Count linked tasks
                    task_count=$(ls -1 "$plan_dir/tasks" 2>/dev/null | wc -l)
                    if [ "$task_count" -gt 0 ]; then
                        printf "  Tasks: %d linked\n" "$task_count"
                    fi
                    echo ""
                fi
            done

            echo "═══════════════════════════════════════════════════════════════"
            echo "Total: $PLAN_COUNT active plan(s)"
            echo "═══════════════════════════════════════════════════════════════"
        fi
        ;;

    show)
        if [ -z "$PLAN_ID" ]; then
            # Try to detect current plan
            CONTEXT=$("$SCRIPT_DIR/bb5-discover-context" json)
            CURRENT_TYPE=$(echo "$CONTEXT" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')

            if [ "$CURRENT_TYPE" = "plan" ]; then
                PLAN_ID=$(echo "$CONTEXT" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')
            else
                echo "Usage: bb5 plan:show [PLAN-ID]"
                echo "Or run from within a plan directory"
                exit 1
            fi
        fi

        PLAN_DIR="$PLANS_DIR/$PLAN_ID"

        if [ ! -d "$PLAN_DIR" ]; then
            echo "Plan not found: $PLAN_ID"
            echo ""
            echo "Available plans:"
            "$SCRIPT_DIR/bb5-plan" list
            exit 1
        fi

        echo "═══════════════════════════════════════════════════════════════"
        printf "  ${CYAN}Plan: %s${NC}\n" "$PLAN_ID"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        # Show metadata if exists
        if [ -f "$PLAN_DIR/metadata.yaml" ]; then
            echo "Metadata:"
            cat "$PLAN_DIR/metadata.yaml"
            echo ""
        fi

        # Show README or plan.md
        if [ -f "$PLAN_DIR/README.md" ]; then
            echo "Description:"
            head -20 "$PLAN_DIR/README.md"
            echo ""
        elif [ -f "$PLAN_DIR/plan.md" ]; then
            echo "Plan:"
            head -20 "$PLAN_DIR/plan.md"
            echo ""
        fi

        echo "═══════════════════════════════════════════════════════════════"
        echo "  Linked Tasks"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        if [ -d "$PLAN_DIR/tasks" ]; then
            TASK_COUNT=$(ls -1 "$PLAN_DIR/tasks" 2>/dev/null | wc -l)
            if [ "$TASK_COUNT" -gt 0 ]; then
                for task_link in "$PLAN_DIR/tasks"/*; do
                    if [ -L "$task_link" ]; then
                        task_name=$(basename "$task_link")
                        task_target=$(readlink "$task_link")
                        printf "  • %s → %s\n" "$task_name" "$task_target"
                    fi
                done
            else
                echo "  No tasks linked to this plan."
                echo ""
                echo "  Link a task:"
                echo "    bb5 link:task [TASK-ID]"
            fi
        else
            echo "  No tasks directory found."
        fi

        echo ""
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Navigation"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""
        echo "  cd $PLAN_DIR"
        echo "  bb5 task:list"
        echo "  bb5 task:create 'New Task'"
        echo ""
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo "Usage: bb5 plan:list | bb5 plan:show [PLAN-ID]"
        exit 1
        ;;
esac
