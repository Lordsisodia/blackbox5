#!/bin/bash
# bb5-task - Task management commands
# Usage: bb5 task:list | bb5 task:show [TASK-ID] | bb5 task:current

set -e
# Source dry-run utility library
source "$(dirname "$0")/../../2-engine/helpers/legacy/dry_run.sh" 2>/dev/null || true

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BLACKBOX5_DIR="$PROJECT_ROOT/5-project-memory/blackbox5"
TASKS_DIR="$BLACKBOX5_DIR/tasks/active"

COMMAND="${1:-list}"
TASK_ID="${2:-}"

# Colors
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    RED='\033[0;31m'
    NC='\033[0m'
else
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    RED=''
    NC=''
fi

case "$COMMAND" in
    list)
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Active Tasks"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        if [ ! -d "$TASKS_DIR" ]; then
            echo "No tasks directory found at $TASKS_DIR"
            exit 1
        fi

        # Count tasks
        TASK_COUNT=$(find "$TASKS_DIR" -maxdepth 1 -type d | grep -v "^$TASKS_DIR$" | wc -l)

        if [ "$TASK_COUNT" -eq 0 ]; then
            echo "No active tasks found."
            echo ""
            echo "Create a task with:"
            echo "  bb5 task:create 'Task Name'"
        else
            for task_dir in "$TASKS_DIR"/*/; do
                if [ -d "$task_dir" ]; then
                    task_id=$(basename "$task_dir")
                    task_file="$task_dir/task.md"

                    task_name="$task_id"
                    task_status="unknown"
                    task_priority="unknown"

                    if [ -f "$task_file" ]; then
                        # Extract task info
                        task_name=$(grep "^# " "$task_file" 2>/dev/null | head -1 | sed 's/^# //' | head -c 50 || echo "$task_id")
                        task_status=$(grep -i "status:" "$task_file" 2>/dev/null | head -1 | sed 's/.*status:[[:space:]]*//' | sed 's/\*\*//g' || echo "unknown")
                        task_priority=$(grep -i "priority:" "$task_file" 2>/dev/null | head -1 | sed 's/.*priority:[[:space:]]*//' | sed 's/\*\*//g' || echo "unknown")
                    fi

                    # Color code by status
                    status_color="$NC"
                    case "$task_status" in
                        completed|done) status_color="$GREEN" ;;
                        in_progress|in-progress) status_color="$YELLOW" ;;
                        pending|todo) status_color="$BLUE" ;;
                        blocked) status_color="$RED" ;;
                    esac

                    # Truncate long names
                    if [ ${#task_name} -gt 45 ]; then
                        task_name="${task_name:0:42}..."
                    fi

                    printf "${CYAN}%s${NC} - %s\n" "$task_id" "$task_name"
                    printf "  Status: ${status_color}%s${NC} | Priority: %s\n" "$task_status" "$task_priority"

                    # Count subtasks
                    subtask_count=$(ls -1 "$task_dir/subtasks" 2>/dev/null | wc -l)
                    if [ "$subtask_count" -gt 0 ]; then
                        printf "  Subtasks: %d\n" "$subtask_count"
                    fi
                    echo ""
                fi
            done

            echo "═══════════════════════════════════════════════════════════════"
            echo "Total: $TASK_COUNT active task(s)"
            echo "═══════════════════════════════════════════════════════════════"
        fi
        ;;

    show)
        if [ -z "$TASK_ID" ]; then
            # Try to detect current task
            CONTEXT=$("$SCRIPT_DIR/bb5-discover-context" json)
            CURRENT_TYPE=$(echo "$CONTEXT" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')

            if [ "$CURRENT_TYPE" = "task" ]; then
                TASK_ID=$(echo "$CONTEXT" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')
            else
                echo "Usage: bb5 task:show [TASK-ID]"
                echo "Or run from within a task directory"
                exit 1
            fi
        fi

        TASK_DIR="$TASKS_DIR/$TASK_ID"

        if [ ! -d "$TASK_DIR" ]; then
            echo "Task not found: $TASK_ID"
            echo ""
            echo "Available tasks:"
            "$SCRIPT_DIR/bb5-task" list
            exit 1
        fi

        echo "═══════════════════════════════════════════════════════════════"
        printf "  ${CYAN}Task: %s${NC}\n" "$TASK_ID"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        # Show task.md
        if [ -f "$TASK_DIR/task.md" ]; then
            cat "$TASK_DIR/task.md"
        else
            echo "No task.md file found"
        fi

        echo ""
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Data Layers"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        for file in THOUGHTS.md DECISIONS.md LEARNINGS.md ASSUMPTIONS.md RESULTS.md; do
            if [ -f "$TASK_DIR/$file" ]; then
                size=$(wc -l < "$TASK_DIR/$file" | tr -d ' ')
                if [ "$size" -gt 0 ]; then
                    printf "  ✓ %s (%d lines)\n" "$file" "$size"
                else
                    printf "  ○ %s (empty)\n" "$file"
                fi
            else
                printf "  ✗ %s (missing)\n" "$file"
            fi
        done

        echo ""
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Subtasks"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""

        if [ -d "$TASK_DIR/subtasks" ]; then
            SUBTASK_COUNT=$(ls -1 "$TASK_DIR/subtasks" 2>/dev/null | wc -l)
            if [ "$SUBTASK_COUNT" -gt 0 ]; then
                for subtask in "$TASK_DIR/subtasks"/*; do
                    if [ -d "$subtask" ]; then
                        subtask_name=$(basename "$subtask")
                        printf "  • %s\n" "$subtask_name"
                    fi
                done
            else
                echo "  No subtasks."
            fi
        else
            echo "  No subtasks directory."
        fi

        echo ""
        echo "═══════════════════════════════════════════════════════════════"
        echo "  Navigation"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""
        echo "  cd $TASK_DIR"
        echo "  bb5 up                    # Go to parent plan"
        echo "  bb5 subtask:create 'Name' # Create subtask"
        echo ""
        ;;

    current)
        # Show current task based on context
        CONTEXT=$("$SCRIPT_DIR/bb5-discover-context" json)
        CURRENT_TYPE=$(echo "$CONTEXT" | grep '"current_type"' | sed 's/.*: "\([^"]*\)".*/\1/')
        CURRENT_ID=$(echo "$CONTEXT" | grep '"current_id"' | sed 's/.*: "\([^"]*\)".*/\1/')

        if [ "$CURRENT_TYPE" = "task" ] && [ -n "$CURRENT_ID" ]; then
            "$SCRIPT_DIR/bb5-task" show "$CURRENT_ID"
        else
            echo "Not currently in a task directory"
            echo ""
            echo "Current location: $CURRENT_TYPE $CURRENT_ID"
            echo ""
            echo "To see a specific task:"
            echo "  bb5 task:show [TASK-ID]"
            echo ""
            echo "To list all tasks:"
            echo "  bb5 task:list"
        fi
        ;;

    *)
        echo "Unknown command: $COMMAND"
        echo "Usage: bb5 task:list | bb5 task:show [TASK-ID] | bb5 task:current"
        exit 1
        ;;
esac
