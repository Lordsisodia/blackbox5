#!/bin/bash
# BB5 Scout + Improve - One-shot improvement run
# Usage: bb5-scout-improve [project-path]

set -e
# Source dry-run utility library
source "$(dirname "$0")/../../2-engine/helpers/legacy/dry_run.sh" 2>/dev/null || true

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BLACKBOX5_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
ENGINE_DIR="$BLACKBOX5_DIR/2-engine"
PROJECT_DIR="${1:-$BLACKBOX5_DIR/5-project-memory/blackbox5}"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║         BB5 Scout + Improve - Self-Improvement              ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Check claude
if ! command -v claude &> /dev/null; then
    echo "Error: claude command not found"
    exit 1
fi

# Setup
PROMPT_FILE="$ENGINE_DIR/instructions/ralf-scout-improve.md"
if [[ ! -f "$PROMPT_FILE" ]]; then
    echo "Error: Prompt not found: $PROMPT_FILE"
    exit 1
fi

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
RUN_DIR="$PROJECT_DIR/.autonomous/runs/run-$TIMESTAMP"
mkdir -p "$RUN_DIR"

# Create template files
cat > "$RUN_DIR/THOUGHTS.md" << 'EOF'
# THOUGHTS - Scout + Improve Run

## Analysis

EOF

cat > "$RUN_DIR/RESULTS.md" << 'EOF'
# RESULTS - Scout + Improve Run

## Opportunities Found

## Quick Wins Implemented

## Validation

EOF

cat > "$RUN_DIR/DECISIONS.md" << 'EOF'
# DECISIONS - Scout + Improve Run

## Prioritization

## Implementation Choices

EOF

cat > "$RUN_DIR/LEARNINGS.md" << 'EOF'
# LEARNINGS - Scout + Improve Run

## Patterns Discovered

EOF

cat > "$RUN_DIR/ASSUMPTIONS.md" << 'EOF'
# ASSUMPTIONS - Scout + Improve Run

EOF

# Export environment
export RALF_PROJECT_DIR="$PROJECT_DIR"
export RALF_ENGINE_DIR="$ENGINE_DIR"
export RALF_BLACKBOX5_DIR="$BLACKBOX5_DIR"
export RALF_RUN_DIR="$RUN_DIR"

echo -e "${BLUE}Project:${NC} $PROJECT_DIR"
echo -e "${BLUE}Run:${NC} $RUN_DIR"
echo ""
echo -e "${YELLOW}Starting RALF in scout-improve mode...${NC}"
echo ""

# Run RALF with scout-improve prompt
cat "$PROMPT_FILE" | claude -p --dangerously-skip-permissions

EXIT_CODE=${PIPESTATUS[0]}

echo ""
if [[ $EXIT_CODE -eq 0 ]]; then
    echo -e "${GREEN}✓ Scout + Improve complete${NC}"
    echo -e "${BLUE}Results:${NC} $RUN_DIR/RESULTS.md"
else
    echo -e "${YELLOW}⚠ Exit code: $EXIT_CODE${NC}"
fi

exit $EXIT_CODE
