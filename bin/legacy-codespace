#!/usr/bin/env python3
"""
Legacy Codespaces CLI - Spawn cloud agents in GitHub Codespaces

Usage:
    legacy-codespace create --name <name> [--branch <branch>] [--machine <type>]
    legacy-codespace list
    legacy-codespace logs <name>
    legacy-codespace stop <name>
    legacy-codespace delete <name>
    legacy-codespace ssh <name>

Examples:
    legacy-codespace create --name docs-improver --branch main
    legacy-codespace create --name engine-refactor --branch refactor --machine premiumLinux
    legacy-codespace logs docs-improver
"""

import argparse
import subprocess
import sys
import json
import os
from datetime import datetime

def run_gh(args, capture=True):
    """Run GitHub CLI command."""
    cmd = ["gh"] + args
    try:
        if capture:
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            return result.stdout
        else:
            subprocess.run(cmd, check=True)
            return ""
    except subprocess.CalledProcessError as e:
        print(f"Error: {e.stderr}")
        return None

def get_codespaces():
    """Get list of Legacy codespaces."""
    output = run_gh(["codespace", "list", "--json", "name,displayName,state,lastUsedAt,gitStatus"])
    if not output:
        return []
    try:
        all_cs = json.loads(output)
        return [cs for cs in all_cs if "legacy-agent" in cs.get("displayName", "")]
    except json.JSONDecodeError:
        return []

def cmd_create(name, branch="main", machine="basicLinux32gb"):
    """Create a new Legacy agent in Codespaces."""
    display_name = f"legacy-agent-{name}"

    print(f"Creating Legacy agent: {display_name}")
    print(f"  Branch: {branch}")
    print(f"  Machine: {machine}")
    print()

    # Determine repo from git remote or use default
    repo = "Lordsisodia/blackbox5"  # Update this to your repo

    # Create codespace
    result = run_gh([
        "codespace", "create",
        "--repo", repo,
        "--branch", branch,
        "--machine", machine,
        "--display-name", display_name
    ])

    if not result:
        print("Failed to create codespace")
        return 1

    codespace_name = result.strip()
    print(f"✓ Codespace created: {codespace_name}")
    print()

    # Wait for codespace to be ready
    print("Waiting for codespace to be ready...")
    run_gh(["codespace", "wait", "-c", codespace_name], capture=False)

    print()
    print("Setting up Legacy agent...")

    # Install Claude Code and configure
    setup_script = """
set -e
echo "Installing Claude Code..."
curl -fsSL https://claude.ai/install.sh | sh

# Create legacy loop
mkdir -p ~/legacy
cat > ~/legacy/loop.sh << 'EOF'
#!/bin/bash
set -e
cd /workspaces/blackbox5

echo "═══════════════════════════════════════════════════════════"
echo "  Legacy Agent Starting"
echo "  Time: $(date)"
echo "═══════════════════════════════════════════════════════════"

# Main loop
while true; do
    echo ""
    echo "[$(date)] Checking for tasks..."

    if [ -d ".autonomous/tasks/active" ]; then
        TASK_FILE=$(ls -t .autonomous/tasks/active/ 2>/dev/null | head -1)
        if [ -n "$TASK_FILE" ]; then
            echo "Executing task: $TASK_FILE"
            claude -p "Read and execute the task from .autonomous/tasks/active/$TASK_FILE" < /dev/null || true
            mv ".autonomous/tasks/active/$TASK_FILE" ".autonomous/tasks/completed/"
            echo "Task completed and moved"
        else
            echo "No tasks found, analyzing codebase..."
            claude -p "Analyze the Blackbox5 codebase and identify one specific improvement to make. Focus on: 1) Code quality 2) Documentation 3) Bug fixes 4) Performance. Then implement it." < /dev/null || true
        fi
    else
        echo "Running general improvement cycle..."
        claude -p "Look at the Blackbox5 codebase and make one concrete improvement. Commit your changes with a descriptive message." < /dev/null || true
    fi

    echo "[$(date)] Cycle complete. Sleeping 120 seconds..."
    sleep 120
done
EOF

chmod +x ~/legacy/loop.sh
echo "✓ Legacy loop created"
"""

    run_gh(["codespace", "ssh", "-c", codespace_name, "--", "-t", setup_script], capture=False)

    print()
    print(f"✓ Legacy agent '{name}' ready!")
    print()
    print(f"To start: legacy-codespace start {name}")
    print(f"To view logs: legacy-codespace logs {name}")
    print(f"To SSH: legacy-codespace ssh {name}")

    return 0

def cmd_start(name):
    """Start the Legacy loop in a codespace."""
    codespaces = get_codespaces()
    cs = None
    for c in codespaces:
        if c.get("displayName") == f"legacy-agent-{name}":
            cs = c
            break

    if not cs:
        print(f"Legacy agent '{name}' not found")
        print("Run 'legacy-codespace list' to see available agents")
        return 1

    codespace_name = cs["name"]
    print(f"Starting Legacy agent: {name}")

    # Start the loop in background
    run_gh([
        "codespace", "ssh", "-c", codespace_name, "--",
        "nohup ~/legacy/loop.sh > ~/legacy/agent.log 2>&1 &"
    ])

    print(f"✓ Legacy agent '{name}' started")
    print(f"View logs: legacy-codespace logs {name}")

    return 0

def cmd_list():
    """List all Legacy agents."""
    print("═══════════════════════════════════════════════════════════")
    print("  Legacy Agents (GitHub Codespaces)")
    print("═══════════════════════════════════════════════════════════")
    print()

    codespaces = get_codespaces()

    if not codespaces:
        print("No Legacy agents found.")
        print()
        print("Create one with: legacy-codespace create --name <name>")
        return 0

    print(f"{'Name':<25} {'State':<12} {'Last Used':<20}")
    print("-" * 60)

    for cs in codespaces:
        name = cs.get("displayName", "").replace("legacy-agent-", "")
        state = cs.get("state", "Unknown")
        last_used = cs.get("lastUsedAt", "Never")[:19] if cs.get("lastUsedAt") else "Never"
        print(f"{name:<25} {state:<12} {last_used:<20}")

    print()
    print(f"Total: {len(codespaces)} agent(s)")
    print()
    print("Commands:")
    print("  legacy-codespace create    # Create new agent")
    print("  legacy-codespace start     # Start agent loop")
    print("  legacy-codespace logs      # View agent logs")
    print("  legacy-codespace stop      # Stop agent")

    return 0

def cmd_logs(name, follow=False):
    """View logs from a Legacy agent."""
    codespaces = get_codespaces()
    cs = None
    for c in codespaces:
        if c.get("displayName") == f"legacy-agent-{name}":
            cs = c
            break

    if not cs:
        print(f"Legacy agent '{name}' not found")
        return 1

    codespace_name = cs["name"]

    if follow:
        print(f"Streaming logs from {name} (Ctrl+C to exit)...")
        run_gh(["codespace", "ssh", "-c", codespace_name, "--", "-t", "tail -f ~/legacy/agent.log"], capture=False)
    else:
        print(f"Recent logs from {name}:")
        print()
        run_gh(["codespace", "ssh", "-c", codespace_name, "--", "tail -50 ~/legacy/agent.log"], capture=False)

    return 0

def cmd_stop(name):
    """Stop a Legacy agent."""
    codespaces = get_codespaces()
    cs = None
    for c in codespaces:
        if c.get("displayName") == f"legacy-agent-{name}":
            cs = c
            break

    if not cs:
        print(f"Legacy agent '{name}' not found")
        return 1

    codespace_name = cs["name"]
    print(f"Stopping Legacy agent: {name}")

    # Kill the loop process
    run_gh(["codespace", "ssh", "-c", codespace_name, "--", "pkill -f 'legacy/loop.sh' || true"])

    print(f"✓ Legacy agent '{name}' stopped")

    return 0

def cmd_delete(name):
    """Delete a Legacy agent."""
    codespaces = get_codespaces()
    cs = None
    for c in codespaces:
        if c.get("displayName") == f"legacy-agent-{name}":
            cs = c
            break

    if not cs:
        print(f"Legacy agent '{name}' not found")
        return 1

    codespace_name = cs["name"]
    print(f"Deleting Legacy agent: {name}")

    run_gh(["codespace", "delete", "-c", codespace_name, "--force"], capture=False)

    print(f"✓ Legacy agent '{name}' deleted")

    return 0

def cmd_ssh(name):
    """SSH into a Legacy agent codespace."""
    codespaces = get_codespaces()
    cs = None
    for c in codespaces:
        if c.get("displayName") == f"legacy-agent-{name}":
            cs = c
            break

    if not cs:
        print(f"Legacy agent '{name}' not found")
        return 1

    codespace_name = cs["name"]
    print(f"Connecting to {name}...")

    run_gh(["codespace", "ssh", "-c", codespace_name], capture=False)

    return 0

def main():
    parser = argparse.ArgumentParser(
        description="Control Legacy agents in GitHub Codespaces",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  legacy-codespace create --name docs-improver
  legacy-codespace create --name engine-refactor --branch refactor --machine premiumLinux
  legacy-codespace list
  legacy-codespace logs docs-improver -f
  legacy-codespace stop docs-improver
  legacy-codespace delete docs-improver
        """
    )

    subparsers = parser.add_subparsers(dest="command", help="Command to run")

    # create
    create_parser = subparsers.add_parser("create", help="Create new Legacy agent")
    create_parser.add_argument("--name", required=True, help="Agent name (e.g., docs-improver)")
    create_parser.add_argument("--branch", default="main", help="Git branch to use")
    create_parser.add_argument("--machine", default="basicLinux32gb",
                               choices=["basicLinux32gb", "standardLinux32gb", "premiumLinux"],
                               help="Machine type")

    # list
    subparsers.add_parser("list", help="List all Legacy agents")

    # start
    start_parser = subparsers.add_parser("start", help="Start Legacy agent loop")
    start_parser.add_argument("name", help="Agent name")

    # logs
    logs_parser = subparsers.add_parser("logs", help="View agent logs")
    logs_parser.add_argument("name", help="Agent name")
    logs_parser.add_argument("-f", "--follow", action="store_true", help="Follow logs")

    # stop
    stop_parser = subparsers.add_parser("stop", help="Stop Legacy agent")
    stop_parser.add_argument("name", help="Agent name")

    # delete
    delete_parser = subparsers.add_parser("delete", help="Delete Legacy agent")
    delete_parser.add_argument("name", help="Agent name")

    # ssh
    ssh_parser = subparsers.add_parser("ssh", help="SSH into Legacy agent")
    ssh_parser.add_argument("name", help="Agent name")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return 1

    # Route to command handler
    if args.command == "create":
        return cmd_create(args.name, args.branch, args.machine)
    elif args.command == "list":
        return cmd_list()
    elif args.command == "start":
        return cmd_start(args.name)
    elif args.command == "logs":
        return cmd_logs(args.name, args.follow)
    elif args.command == "stop":
        return cmd_stop(args.name)
    elif args.command == "delete":
        return cmd_delete(args.name)
    elif args.command == "ssh":
        return cmd_ssh(args.name)

    return 0

if __name__ == "__main__":
    sys.exit(main())
