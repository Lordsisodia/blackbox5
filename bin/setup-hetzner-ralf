#!/bin/bash
#
# RALF Hetzner Setup Script
# Automates creation of Hetzner server with RALF agents
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${BLUE}[SETUP]${NC} $*"; }
success() { echo -e "${GREEN}[OK]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Configuration
HETZNER_API_TOKEN="${HETZNER_API_TOKEN:-}"
SERVER_NAME="${SERVER_NAME:-ralf-agents}"
SERVER_TYPE="${SERVER_TYPE:-cx23}"  # 4GB RAM, 2 vCPUs
LOCATION="${LOCATION:-nbg1}"  # Nuremberg, Germany
IMAGE="${IMAGE:-ubuntu-22.04}"
SSH_KEY_NAME="${SSH_KEY_NAME:-ralf-key}"

# Check dependencies
check_deps() {
    local missing=()

    if ! command -v hcloud &> /dev/null; then
        missing+=("hcloud")
    fi

    if ! command -v ssh &> /dev/null; then
        missing+=("ssh")
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        error "Missing dependencies: ${missing[*]}"
        log "Install hcloud CLI:"
        log "  brew install hcloud  # macOS"
        log "  or download from https://github.com/hetznercloud/cli/releases"
        exit 1
    fi
}

# Check API token
check_token() {
    if [[ -z "$HETZNER_API_TOKEN" ]]; then
        error "HETZNER_API_TOKEN not set"
        log "Get your API token from: https://console.hetzner.cloud/projects"
        log "Then run: export HETZNER_API_TOKEN=your_token"
        exit 1
    fi

    export HCLOUD_TOKEN="$HETZNER_API_TOKEN"

    # Test token
    if ! hcloud context list &> /dev/null; then
        hcloud context create ralf-setup
    fi
}

# Generate SSH key if needed
setup_ssh_key() {
    local key_path="$HOME/.ssh/ralf_hetzner"

    if [[ ! -f "$key_path" ]]; then
        log "Generating SSH key pair..."
        ssh-keygen -t ed25519 -f "$key_path" -N "" -C "ralf@hetzner"
        success "SSH key generated at $key_path"
    else
        log "Using existing SSH key at $key_path"
    fi

    # Upload to Hetzner if not exists
    if ! hcloud ssh-key describe "$SSH_KEY_NAME" &> /dev/null; then
        log "Uploading SSH key to Hetzner..."
        hcloud ssh-key create --name "$SSH_KEY_NAME" --public-key-from-file "$key_path.pub"
        success "SSH key uploaded"
    fi

    echo "$key_path"
}

# Create server
create_server() {
    log "Creating Hetzner server: $SERVER_NAME"
    log "Type: $SERVER_TYPE (4GB RAM, 2 vCPUs)"
    log "Location: $LOCATION"

    # Check if server exists
    if hcloud server describe "$SERVER_NAME" &> /dev/null; then
        warn "Server $SERVER_NAME already exists"
        local ip
        ip=$(hcloud server ip "$SERVER_NAME")
        echo "$ip"
        return 0
    fi

    # Create server
    hcloud server create \
        --name "$SERVER_NAME" \
        --type "$SERVER_TYPE" \
        --image "$IMAGE" \
        --location "$LOCATION" \
        --ssh-key "$SSH_KEY_NAME" \
        --label "app=ralf" \
        --wait

    local ip
    ip=$(hcloud server ip "$SERVER_NAME")
    success "Server created with IP: $ip"

    # Wait for SSH to be ready
    log "Waiting for SSH to be ready..."
    local retries=30
    while ! ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i "$HOME/.ssh/ralf_hetzner" "root@$ip" "echo OK" &> /dev/null; do
        sleep 2
        retries=$((retries - 1))
        if [[ $retries -eq 0 ]]; then
            error "SSH not available after 60 seconds"
            exit 1
        fi
    done
    success "SSH is ready"

    echo "$ip"
}

# Setup Docker and dependencies on server
setup_server() {
    local ip="$1"
    local ssh_key="$2"

    log "Setting up Docker and dependencies on server..."

    ssh -o StrictHostKeyChecking=no -i "$ssh_key" "root@$ip" << 'REMOTE_SCRIPT'
# Update system
apt-get update && apt-get upgrade -y

# Install Docker
curl -fsSL https://get.docker.com | sh

# Install Docker Compose
mkdir -p /usr/local/lib/docker/cli-plugins
curl -SL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# Add user to docker group
usermod -aG docker root

# Install other dependencies
apt-get install -y git tmux htop

# Create directories
mkdir -p /opt/ralf
mkdir -p /opt/ralf/project
mkdir -p /opt/ralf/.autonomous

# Install Claude Code CLI
curl -fsSL https://claude.ai/install | sh

echo "Setup complete!"
REMOTE_SCRIPT

    success "Server setup complete"
}

# Create docker-compose file on server
create_docker_compose() {
    local ip="$1"
    local ssh_key="$2"

    log "Creating Docker Compose configuration..."

    ssh -o StrictHostKeyChecking=no -i "$ssh_key" "root@$ip" << 'REMOTE_SCRIPT'
cat > /opt/ralf/docker-compose.yml << 'DOCKER_EOF'
version: '3.8'

services:
  ralf-planner:
    image: debian:bookworm-slim
    container_name: ralf-planner
    working_dir: /app
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-https://api.z.ai/api/anthropic}
      - RALF_MODE=plan
      - RALF_PROJECT_DIR=/app/project
      - RALF_ENGINE_DIR=/app/engine
    volumes:
      - ./project:/app/project
      - ./engine:/app/engine
      - ./scripts:/app/scripts
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y curl git tmux python3 python3-pip &&
        curl -fsSL https://claude.ai/install | sh &&
        cd /app/project &&
        while true; do
          /app/scripts/ralf-planner-v2 || sleep 10
        done
      "
    restart: unless-stopped
    mem_limit: 2g

  ralf-executor:
    image: debian:bookworm-slim
    container_name: ralf-executor
    working_dir: /app
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-https://api.z.ai/api/anthropic}
      - RALF_MODE=execute
      - RALF_PROJECT_DIR=/app/project
      - RALF_ENGINE_DIR=/app/engine
    volumes:
      - ./project:/app/project
      - ./engine:/app/engine
      - ./scripts:/app/scripts
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y curl git tmux python3 python3-pip &&
        curl -fsSL https://claude.ai/install | sh &&
        cd /app/project &&
        while true; do
          /app/scripts/ralf-executor-v2 || sleep 10
        done
      "
    restart: unless-stopped
    mem_limit: 2g

  keepalive:
    image: python:3.11-slim
    container_name: ralf-keepalive
    working_dir: /app
    ports:
      - "8080:8080"
    command: >
      bash -c "
        pip install flask &&
        cat > server.py << 'PYEOF'
from flask import Flask
import datetime
app = Flask(__name__)

@app.route('/')
def keepalive():
    return f'RALF Keep-Alive OK - {datetime.datetime.utcnow().isoformat()}'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
PYEOF
        python server.py
      "
    restart: unless-stopped
    mem_limit: 256m
DOCKER_EOF

echo "Docker Compose file created"
REMOTE_SCRIPT

    success "Docker Compose configuration created"
}

# Setup GitHub Actions deployment
setup_github_actions() {
    local ip="$1"

    log "Setting up GitHub Actions deployment..."

    # Create GitHub Actions workflow directory
    mkdir -p .github/workflows

    cat > .github/workflows/deploy-hetzner.yml << GHA_EOF
name: Deploy to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Hetzner
        uses: appleboy/ssh-action@master
        with:
          host: $ip
          username: root
          key: \${{ secrets.HETZNER_SSH_KEY }}
          script: |
            cd /opt/ralf
            git pull origin main
            docker compose pull
            docker compose up -d --build

      - name: Notify success
        run: echo "Deployment complete!"
GHA_EOF

    success "GitHub Actions workflow created at .github/workflows/deploy-hetzner.yml"
    log "Add these secrets to GitHub:"
    log "  - HETZNER_SSH_KEY: Content of ~/.ssh/ralf_hetzner"
    log "  - ANTHROPIC_API_KEY: Your GLM API key"
}

# Print connection info
print_info() {
    local ip="$1"
    local ssh_key="$2"

    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  RALF Server Setup Complete!"
    echo "═══════════════════════════════════════════════════════════════"
    echo ""
    echo "Server IP: $ip"
    echo "SSH Key: $ssh_key"
    echo ""
    echo "Connection commands:"
    echo "  ssh -i $ssh_key root@$ip"
    echo ""
    echo "View agents:"
    echo "  ssh -i $ssh_key root@$ip 'docker ps'"
    echo ""
    echo "View logs:"
    echo "  ssh -i $ssh_key root@$ip 'docker logs ralf-planner'"
    echo "  ssh -i $ssh_key root@$ip 'docker logs ralf-executor'"
    echo ""
    echo "Keepalive URL: http://$ip:8080"
    echo ""
    echo "Next steps:"
    echo "  1. Add HETZNER_SSH_KEY to GitHub Secrets"
    echo "  2. Add ANTHROPIC_API_KEY to GitHub Secrets"
    echo "  3. Push code to deploy agents"
    echo ""
    echo "═══════════════════════════════════════════════════════════════"
}

# Main setup
main() {
    log "RALF Hetzner Setup"
    log "=================="
    echo ""

    check_deps
    check_token

    local ssh_key
    ssh_key=$(setup_ssh_key)

    local ip
    ip=$(create_server)

    setup_server "$ip" "$ssh_key"
    create_docker_compose "$ip" "$ssh_key"
    setup_github_actions "$ip"

    print_info "$ip" "$ssh_key"
}

# Run main
main "$@"
