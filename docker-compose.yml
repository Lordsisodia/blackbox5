# ============================================================================
# Blackbox5 - Docker Compose Configuration
# ============================================================================
# Purpose: Full-stack orchestration for Blackbox5 AI development platform
# Services: API, Redis, Neo4j, PostgreSQL, ChromaDB, RALF Agent
# ============================================================================

version: "3.9"

# =============================================================================
# SERVICES
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # API Server - FastAPI application
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: bb5-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - BB5_ENV=production
      - BB5_LOG_LEVEL=info
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-blackbox5}
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-blackbox5}@postgres:5432/blackbox5
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - ./engine:/opt/blackbox5/engine:ro
      - ./5-project-memory:/opt/blackbox5/5-project-memory
      - ./6-roadmap:/opt/blackbox5/6-roadmap
      - bb5-logs:/opt/blackbox5/.logs
    depends_on:
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      postgres:
        condition: service_healthy
      chromadb:
        condition: service_started
    networks:
      - bb5-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ---------------------------------------------------------------------------
  # RALF Agent - Autonomous task execution
  # ---------------------------------------------------------------------------
  ralf-agent:
    build:
      context: .
      dockerfile: 6-roadmap/01-research/infrastructure/docker/Dockerfile.ralf-agent
    container_name: bb5-ralf-agent
    restart: unless-stopped
    environment:
      - RALF_MODE=daemon
      - RALF_PROJECT_DIR=/opt/blackbox5/5-project-memory/blackbox5
      - RALF_ENGINE_DIR=/opt/blackbox5/2-engine/.autonomous
      - RALF_BLACKBOX5_DIR=/opt/blackbox5
      - REDIS_URL=redis://redis:6379/0
      - BB5_API_URL=http://api:8000
    volumes:
      - .:/opt/blackbox5
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ralf-home:/home/ralf
    depends_on:
      - api
      - redis
    networks:
      - bb5-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # ---------------------------------------------------------------------------
  # Redis - Event bus and caching
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: bb5-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - bb5-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ---------------------------------------------------------------------------
  # Neo4j - Graph database for brain/memory system
  # ---------------------------------------------------------------------------
  neo4j:
    image: neo4j:5.15-community
    container_name: bb5-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-blackbox5}
      - NEO4J_PLUGINS=["apoc", "gds"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-plugins:/plugins
    networks:
      - bb5-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

  # ---------------------------------------------------------------------------
  # PostgreSQL - Relational database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: bb5-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-blackbox5}
      - POSTGRES_DB=blackbox5
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
    networks:
      - bb5-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ---------------------------------------------------------------------------
  # ChromaDB - Vector database for embeddings
  # ---------------------------------------------------------------------------
  chromadb:
    image: chromadb/chroma:0.4.22
    container_name: bb5-chromadb
    restart: unless-stopped
    ports:
      - "8001:8000"
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - CHROMA_SERVER_AUTH_PROVIDER=${CHROMA_AUTH_PROVIDER:-}
      - CHROMA_SERVER_AUTH_CREDENTIALS=${CHROMA_AUTH_CREDENTIALS:-}
    volumes:
      - chromadb-data:/chroma/chroma
    networks:
      - bb5-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # ---------------------------------------------------------------------------
  # Nginx - Reverse proxy and static file serving
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: bb5-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./1-docs:/usr/share/nginx/html/docs:ro
    depends_on:
      - api
    networks:
      - bb5-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  bb5-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  redis-data:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  neo4j-plugins:
    driver: local
  postgres-data:
    driver: local
  chromadb-data:
    driver: local
  bb5-logs:
    driver: local
  ralf-home:
    driver: local
